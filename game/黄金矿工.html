<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ±å‡ªçš„æ·±æ¸ŠçŸ¿å·¥ Final Plus (â‰§â—¡â‰¦)</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0d0d1a; 
            color: white;
            user-select: none;
        }
        #game-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
        }
        canvas {
            background: linear-gradient(to bottom, #202030 0%, #050510 100%);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            border-radius: 10px;
        }
        
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* === æ–°å¢ï¼šå¸¸é©»é“å…·æ  === */
        #inventory-hud {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
            z-index: 100; /* ä¿è¯åœ¨æœ€ä¸Šå±‚ */
        }
        .inv-item {
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #555;
            font-size: 18px;
            color: #fff;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
            display: flex;
            align-items: center;
            gap: 5px;
            backdrop-filter: blur(4px);
            transition: transform 0.2s;
        }
        .inv-item.active {
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* HUD */
        #hud {
            position: absolute;
            top: 20px;
            display: none;
            width: 850px;
            justify-content: flex-end; /* æ”¹ä¸ºé å³ï¼Œç»™å·¦è¾¹é“å…·æ ç•™ä½ç½® */
            gap: 20px; /* ç›’å­é—´è· */
            font-size: 20px;
            font-weight: bold;
            text-shadow: 2px 2px 0 #000;
            z-index: 10;
        }
        .hud-box {
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 20px;
            border-radius: 15px;
            border: 2px solid #555;
            display: flex; flex-direction: column; align-items: center;
            backdrop-filter: blur(5px);
            min-width: 80px;
        }
        .label { font-size: 14px; color: #aaa; margin-bottom: 2px; }
        .val { font-size: 24px; color: #ffd700; }
        
        /* å±å¹•èœå• */
        .screen {
            background: rgba(20, 20, 35, 0.95);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 4px solid #ffd700;
            box-shadow: 0 0 80px rgba(255, 215, 0, 0.15);
            pointer-events: auto;
            display: none;
            flex-direction: column;
            align-items: center;
            min-width: 450px;
            animation: fadeIn 0.3s ease-out;
            z-index: 20;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        h1 { margin: 0 0 20px 0; color: #ffd700; font-size: 42px; text-shadow: 0 0 15px #ff8c00; letter-spacing: 2px; }
        h2 { color: #fff; margin-bottom: 20px; font-size: 28px; }
        
        button {
            background: linear-gradient(to bottom, #ffd700, #ff8c00);
            border: none;
            padding: 12px 40px;
            color: #330000;
            font-size: 20px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 5px 0 #b8860b;
            margin: 10px;
            min-width: 180px;
        }
        button:active { transform: translateY(4px); box-shadow: 0 1px 0 #b8860b; }
        button:hover { filter: brightness(1.15); transform: translateY(-2px); }
        button.secondary { background: linear-gradient(to bottom, #555, #333); color: #ddd; box-shadow: 0 5px 0 #222; }
        
        /* å…³å¡é€‰æ‹©æŒ‰é’® */
        .level-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }
        .level-grid::-webkit-scrollbar { width: 8px; }
        .level-grid::-webkit-scrollbar-track { background: #222; border-radius: 4px; }
        .level-grid::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

        .level-btn {
            width: 60px; height: 60px;
            border-radius: 12px;
            background: linear-gradient(135deg, #444, #222);
            border: 2px solid #666;
            color: #fff;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.2s;
            position: relative;
        }
        .level-btn:hover:not(.locked) {
            border-color: #ffd700;
            background: #555;
            transform: scale(1.1);
        }
        .level-btn.locked {
            opacity: 0.5;
            cursor: not-allowed;
            background: #111;
            border-color: #333;
            color: #555;
        }
        .level-btn.locked::after {
            content: 'ğŸ”’';
            font-size: 16px;
            position: absolute;
        }

        /* å•†åº—ç‰©å“ */
        .shop-grid { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .shop-item {
            background: rgba(255,255,255,0.1); border: 2px solid #555; border-radius: 10px;
            padding: 15px; width: 120px; cursor: pointer; transition: all 0.2s; position: relative;
        }
        .shop-item:hover:not(.bought) { border-color: #fff; background: rgba(255,255,255,0.2); transform: translateY(-5px); }
        .shop-item.bought { opacity: 0.5; pointer-events: none; border-color: #00ff00; }
        .shop-item.bought::after { content: 'å·²æ‹¥æœ‰'; position: absolute; bottom: 5px; left: 0; width: 100%; font-size: 12px; color: #00ff00; }
        .shop-icon { font-size: 32px; margin-bottom: 10px; display: block; }
        .shop-price { color: #00ff00; font-weight: bold; font-size: 14px; }
        .shop-name { color: #ddd; font-size: 14px; margin-bottom: 5px; display: block;}

        /* æµ®åŠ¨æ–‡å­— */
        .floater {
            position: absolute; font-weight: bold; font-size: 24px; color: #ffff00;
            text-shadow: 0 0 5px #000; pointer-events: none; animation: floatUp 1s forwards;
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        .controls-table {
            text-align: left; color: #ccc; font-size: 16px; margin-bottom: 20px;
            background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px;
        }
        .key-hint { 
            display: inline-block; background: #444; padding: 2px 8px; 
            border-radius: 4px; border: 1px solid #666; font-family: monospace; color: #fff; font-weight: bold;
        }
        
        .stats-row { display: flex; gap: 40px; margin-bottom: 30px; background: rgba(0,0,0,0.3); padding: 15px 30px; border-radius: 15px; }
        .stat-item { display: flex; flex-direction: column; }
        .stat-val { font-size: 24px; color: #ffd700; font-weight: bold; }
        .stat-lbl { font-size: 14px; color: #aaa; }

        #home-screen { display: flex; }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas" width="900" height="600"></canvas>
    </div>

    <div id="ui-layer">
        
        <!-- å¸¸é©»å·¦ä¸Šè§’ï¼šé“å…·æ  -->
        <div id="inventory-hud">
            <div class="inv-item" id="inv-bomb">
                <span style="font-size: 20px">ğŸ§¨</span> 
                <span id="bomb-count">0</span>
            </div>
            <div class="inv-item active" id="inv-strength" style="display: none; color: #ff69b4;">
                <span style="font-size: 20px">ğŸ§ª</span> åŠ›é‡UP
            </div>
            <div class="inv-item active" id="inv-lucky" style="display: none; color: #00ff00;">
                <span style="font-size: 20px">ğŸ€</span> å¹¸è¿UP
            </div>
        </div>

        <!-- æ¸¸æˆçŠ¶æ€ HUD (é¡¶éƒ¨åå³) -->
        <div id="hud">
            <div class="hud-box"><span class="label">ç›®æ ‡ $</span><span class="val" id="target-score">0</span></div>
            <div class="hud-box"><span class="label">æ—¶é—´</span><span class="val" id="time-left">60</span></div>
            <div class="hud-box"><span class="label">é‡‘é’± $</span><span class="val" id="current-score">0</span></div>
            <div class="hud-box"><span class="label">æ·±æ¸Šå±‚çº§</span><span class="val" id="level-num">1</span></div>
        </div>

        <!-- 1. ä¸»é¡µ -->
        <div id="home-screen" class="screen">
            <h1>â›ï¸ æ·±æ¸ŠçŸ¿å·¥</h1>
            <div class="stats-row">
                <div class="stat-item"><span class="stat-val" id="home-total-gold">0</span><span class="stat-lbl">ç”Ÿæ¶¯è´¢å¯Œ</span></div>
                <div class="stat-item"><span class="stat-val" id="home-max-level">1</span><span class="stat-lbl">æœ€æ·±å±‚æ•°</span></div>
            </div>
            <button onclick="showLevelSelect()">å¼€å§‹æ¢é™©</button>
        </div>

        <!-- 2. å…³å¡é€‰æ‹© -->
        <div id="level-screen" class="screen">
            <h2>ğŸ—ºï¸ é€‰æ‹©å±‚çº§</h2>
            <div class="level-grid" id="level-buttons">
                <!-- JS ç”Ÿæˆ -->
            </div>
            <button class="secondary" onclick="goHome()">è¿”å›ä¸»é¡µ</button>
        </div>

        <!-- 3. æš‚åœèœå• -->
        <div id="pause-screen" class="screen">
            <h2>â¸ï¸ æš‚åœ</h2>
            <div class="controls-table">
                <p><span class="key-hint">â†“</span> / <span class="key-hint">SPACE</span> å‘å°„é’©çˆª</p>
                <p><span class="key-hint">â†‘</span> / <span class="key-hint">W</span> ç‚¸è¯ (æ‹‰å–æ—¶)</p>
                <p><span class="key-hint">ESC</span> ç»§ç»­/æš‚åœ</p>
            </div>
            <button onclick="togglePause()">ç»§ç»­æ¸¸æˆ</button>
            <button class="secondary" onclick="goHome()">è¿”å›ä¸»é¡µ</button>
        </div>

        <!-- 4. å•†åº— -->
        <div id="shop-screen" class="screen">
            <h2>ğŸ›’ æ·±æ¸Šè¡¥ç»™ç«™</h2>
            <p>ä¸‹ä¸€å±‚ç›®æ ‡: <span id="next-target" style="color: #ffd700; font-weight:bold;">0</span></p>
            <p>å½“å‰èµ„é‡‘: <span id="shop-money" style="color: #00ffff; font-weight:bold;">0</span></p>
            
            <div class="shop-grid">
                <div class="shop-item" id="shop-bomb" onclick="buyItem('bomb')">
                    <span class="shop-icon">ğŸ§¨</span>
                    <span class="shop-name">å¼ºåŠ›ç‚¸è¯</span>
                    <span class="shop-price">$200</span>
                </div>
                <div class="shop-item" id="shop-potion" onclick="buyItem('potion')">
                    <span class="shop-icon">ğŸ§ª</span>
                    <span class="shop-name">å¤§åŠ›è¯æ°´</span>
                    <span class="shop-price">$400</span>
                </div>
                <div class="shop-item" id="shop-clover" onclick="buyItem('clover')">
                    <span class="shop-icon">ğŸ€</span>
                    <span class="shop-name">å¹¸è¿è‰</span>
                    <span class="shop-price">$100</span>
                </div>
            </div>
            <button onclick="nextLevelStart()">ç»§ç»­æ·±å…¥ â”</button>
        </div>

        <!-- 5. ç»“ç®— -->
        <div id="end-screen" class="screen">
            <h1 id="end-title">ğŸ’” æŒ‘æˆ˜å¤±è´¥</h1>
            <p>æ­¢æ­¥äºç¬¬ <span id="end-level">1</span> å±‚</p>
            <p>æœ€ç»ˆè´¢å¯Œ: <span id="final-score" style="color: #ffd700; font-size: 32px; font-weight: bold;">0</span></p>
            <button onclick="showLevelSelect()">å†æ¬¡æŒ‘æˆ˜</button>
            <button class="secondary" onclick="goHome()">è¿”å›ä¸»é¡µ</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        function getStorage(key) { try { return parseInt(localStorage.getItem(key)) || 0; } catch (e) { return 0; } }
        function setStorage(key, value) { try { localStorage.setItem(key, value); } catch (e) {} }

        const STATE = { HOME: 0, LEVEL_SELECT: 1, PLAYING: 2, PAUSED: 3, SHOP: 4, END: 5 };
        let currentState = STATE.HOME;
        
        let maxUnlockedLevel = Math.max(1, getStorage('minerMaxLevel'));
        let lifetimeGold = getStorage('minerLifetimeGold');

        let score = 0;
        let targetScore = 0;
        let level = 1;
        let time = 60;
        let lastTime = 0;
        let items = [];
        let particles = [];
        let floaters = []; 
        
        let inventory = { bombs: 1, strength: false, lucky: false };

        const hook = {
            x: 450, y: 70, angle: 0, angleSpeed: 0.03, angleDir: 1,
            length: 50, minLength: 50, maxLength: 800,
            status: 0, shootSpeed: 10, pullSpeed: 0, grabbedItem: null, ropeColor: '#777'
        };

        const ITEM_TYPES = {
            GOLD_S: { radius: 15, value: 50, weight: 1, color: '#ffd700', label: 'S' },
            GOLD_M: { radius: 25, value: 100, weight: 3, color: '#ffd700', label: 'M' },
            GOLD_L: { radius: 40, value: 250, weight: 6, color: '#ffd700', label: 'L' },
            GOLD_XL:{ radius: 60, value: 500, weight: 10, color: '#ffd700', label: 'XL'},
            ROCK_S: { radius: 20, value: 11,  weight: 5, color: '#808080', label: 'R' },
            ROCK_L: { radius: 35, value: 20,  weight: 12,color: '#808080', label: 'R' },
            DIAMOND:{ radius: 12, value: 600, weight: 0.5,color: '#00ffff', label: 'D' },
            BAG:    { radius: 20, value: 0,   weight: 2,  color: '#ff69b4', label: '?' } 
        };

        updateHomeStats();
        updateInventoryUI(); // åˆå§‹åŒ–æ˜¾ç¤ºé“å…·
        requestAnimationFrame(gameLoop);

        function updateHomeStats() {
            document.getElementById('home-total-gold').innerText = lifetimeGold;
            document.getElementById('home-max-level').innerText = maxUnlockedLevel;
        }

        // === æ–°å¢ï¼šæ›´æ–°é“å…·æ UI ===
        function updateInventoryUI() {
            // ç‚¸å¼¹
            document.getElementById('bomb-count').innerText = inventory.bombs;
            
            // è¯æ°´
            const strengthEl = document.getElementById('inv-strength');
            strengthEl.style.display = inventory.strength ? 'flex' : 'none';
            
            // å¹¸è¿è‰
            const luckyEl = document.getElementById('inv-lucky');
            luckyEl.style.display = inventory.lucky ? 'flex' : 'none';
        }

        function hideAllScreens() {
            document.querySelectorAll('.screen').forEach(el => el.style.display = 'none');
            document.getElementById('hud').style.display = 'none';
        }

        window.goHome = function() {
            currentState = STATE.HOME;
            hideAllScreens();
            document.getElementById('home-screen').style.display = 'flex';
            updateHomeStats();
        }

        window.showLevelSelect = function() {
            currentState = STATE.LEVEL_SELECT;
            hideAllScreens();
            document.getElementById('level-screen').style.display = 'flex';
            
            const grid = document.getElementById('level-buttons');
            grid.innerHTML = '';
            for (let i = 1; i <= 20; i++) {
                const btn = document.createElement('div');
                btn.className = 'level-btn';
                btn.innerText = i;
                if (i > maxUnlockedLevel) {
                    btn.classList.add('locked');
                } else {
                    btn.onclick = () => startLevel(i);
                }
                grid.appendChild(btn);
            }
        }

        function startLevel(lvl) {
            level = lvl;
            if (lvl === 1) {
                score = 0;
                inventory = { bombs: 1, strength: false, lucky: false };
            } else {
                score = calculateTargetScore(lvl - 1);
                inventory = { bombs: 1, strength: false, lucky: false };
            }

            initLevelData();
            currentState = STATE.PLAYING;
            hideAllScreens();
            document.getElementById('hud').style.display = 'flex';
            lastTime = performance.now();
        }

        function calculateTargetScore(lvl) {
            if (lvl <= 0) return 0;
            let target = 0;
            for(let i=1; i<=lvl; i++) {
                target += 650 + (i-1)*350; 
            }
            return target;
        }

        window.togglePause = function() {
            if (currentState === STATE.PLAYING) {
                currentState = STATE.PAUSED;
                document.getElementById('pause-screen').style.display = 'flex';
            } else if (currentState === STATE.PAUSED) {
                currentState = STATE.PLAYING;
                document.getElementById('pause-screen').style.display = 'none';
                lastTime = performance.now(); 
            }
        }

        function initLevelData() {
            time = 60;
            let requiredEarn = 650 + (level-1) * 350;
            targetScore = score + requiredEarn;
            
            updateHUD();
            updateInventoryUI(); // æ›´æ–° UI

            items = [];
            let itemCount = 12 + Math.min(level, 10);
            for (let i = 0; i < itemCount; i++) spawnRandomItem();
            
            let diamondCount = inventory.lucky ? 2 + Math.floor(level/3) : Math.floor(level/5);
            for (let i=0; i<diamondCount; i++) spawnItem('DIAMOND');
            
            hook.angle = 0;
            hook.status = 0;
            hook.grabbedItem = null;
        }

        function spawnRandomItem() {
            const rand = Math.random();
            let type;
            if (rand < 0.1) type = 'DIAMOND';
            else if (rand < 0.3) type = 'GOLD_L';
            else if (rand < 0.4) type = 'GOLD_XL';
            else if (rand < 0.6) type = 'GOLD_M';
            else if (rand < 0.75) type = 'GOLD_S';
            else if (rand < 0.85) type = 'BAG';
            else if (rand < 0.95) type = 'ROCK_L';
            else type = 'ROCK_S';
            spawnItem(type);
        }

        function spawnItem(typeKey) {
            const template = ITEM_TYPES[typeKey];
            let x = Math.random() * (canvas.width - 80) + 40;
            let y = Math.random() * (canvas.height - 250) + 200;
            items.push({ x, y, ...template, type: typeKey, rotation: Math.random() * Math.PI });
        }

        function gameLoop(timestamp) {
            const deltaTime = (timestamp - lastTime) / 1000;
            lastTime = timestamp;

            if (currentState === STATE.PLAYING) {
                update(deltaTime);
                draw();
            } else if (currentState === STATE.PAUSED || currentState === STATE.SHOP) {
                draw();
            } else if (currentState === STATE.HOME) {
                drawBackgroundOnly();
            }
            
            requestAnimationFrame(gameLoop);
        }

        function update(dt) {
            time -= dt;
            if (time <= 0) {
                time = 0;
                checkLevelEnd();
            }
            document.getElementById('time-left').innerText = Math.ceil(time);

            if (hook.status === 0) { 
                hook.angle += hook.angleSpeed * hook.angleDir;
                if (hook.angle > 1.3 || hook.angle < -1.3) hook.angleDir *= -1;
            } else if (hook.status === 1) { 
                hook.length += hook.shootSpeed;
                if (hook.length > hook.maxLength || 
                    hook.x + Math.sin(hook.angle) * hook.length < 0 || 
                    hook.x + Math.sin(hook.angle) * hook.length > canvas.width ||
                    hook.y + Math.cos(hook.angle) * hook.length > canvas.height) {
                    hook.status = 2;
                    hook.pullSpeed = 15; 
                }
                
                let hx = hook.x + Math.sin(hook.angle) * hook.length;
                let hy = hook.y + Math.cos(hook.angle) * hook.length;
                for (let i = 0; i < items.length; i++) {
                    let it = items[i];
                    if ((hx-it.x)**2 + (hy-it.y)**2 < it.radius**2) {
                        hook.status = 2;
                        hook.grabbedItem = it;
                        let strengthFactor = inventory.strength ? 2.5 : 1;
                        hook.pullSpeed = Math.max(1, (10 / it.weight) * strengthFactor); 
                        items.splice(i, 1);
                        break;
                    }
                }
            } else if (hook.status === 2) { 
                hook.length -= hook.pullSpeed;
                if (hook.length <= hook.minLength) {
                    hook.length = hook.minLength;
                    hook.status = 0;
                    if (hook.grabbedItem) {
                        processItem(hook.grabbedItem);
                        hook.grabbedItem = null;
                    }
                }
            }

            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= dt;
                if (p.life <= 0) particles.splice(i, 1);
            }
            
            for (let i = floaters.length - 1; i >= 0; i--) {
                let f = floaters[i];
                f.y -= 1; f.life -= dt;
                if (f.life <= 0) floaters.splice(i, 1);
            }
        }

        function processItem(item) {
            let val = item.value;
            let text = "+" + val;
            let color = "#ffff00";

            if (item.type === 'BAG') {
                let r = Math.random();
                if (r < 0.3) { val = 50; text = "è¿æ°”ä¸€èˆ¬..."; color = "#aaa"; }
                else if (r < 0.6) { val = 300; text = "å¥½è¿!"; color = "#ff69b4"; }
                else if (r < 0.8) { val = 1; inventory.strength = true; text = "ç¥åŠ›åŠ æŒ!"; color = "#f00"; }
                else { val = 800; text = "è¶…çº§å¤§å¥–!"; color = "#00ffff"; }
            } else if (item.type.includes('ROCK')) color = "#888";

            score += val;
            lifetimeGold += val;
            setStorage('minerLifetimeGold', lifetimeGold);
            
            createFloatingText(text, hook.x, hook.y + 50, color);
            updateHUD();
            updateInventoryUI(); // æ›´æ–°é“å…·æ˜¾ç¤ºï¼ˆä¸‡ä¸€è¢‹å­å¼€å‡ºè¯æ°´ï¼‰
        }

        function checkLevelEnd() {
            if (score >= targetScore) {
                if (level >= maxUnlockedLevel) {
                    maxUnlockedLevel = level + 1;
                    setStorage('minerMaxLevel', maxUnlockedLevel);
                }
                
                inventory.strength = false;
                inventory.lucky = false;

                currentState = STATE.SHOP;
                hideAllScreens();
                document.getElementById('shop-screen').style.display = 'flex';
                
                let nextReq = 650 + (level) * 350;
                document.getElementById('next-target').innerText = score + nextReq;
                document.getElementById('shop-money').innerText = score;
                
                document.getElementById('shop-potion').classList.remove('bought');
                document.getElementById('shop-clover').classList.remove('bought');
                
                updateInventoryUI(); // æ›´æ–°UIçŠ¶æ€
                
            } else {
                currentState = STATE.END;
                hideAllScreens();
                document.getElementById('end-screen').style.display = 'flex';
                document.getElementById('end-level').innerText = level;
                document.getElementById('final-score').innerText = score;
            }
        }

        window.buyItem = function(item) {
            let price = 0;
            if (item === 'bomb') price = 200;
            if (item === 'potion') price = 400;
            if (item === 'clover') price = 100;

            if (score >= price) {
                if (item === 'potion' && inventory.strength) return;
                if (item === 'clover' && inventory.lucky) return;

                score -= price;
                document.getElementById('shop-money').innerText = score;
                updateHUD();

                if (item === 'bomb') {
                    inventory.bombs++;
                    createFloatingText("ç‚¸è¯+1", canvas.width/2, canvas.height/2 - 50, "#0f0");
                }
                if (item === 'potion') {
                    inventory.strength = true;
                    document.getElementById('shop-potion').classList.add('bought');
                    createFloatingText("åŠ›é‡UP!", canvas.width/2, canvas.height/2 - 50, "#0f0");
                }
                if (item === 'clover') {
                    inventory.lucky = true;
                    document.getElementById('shop-clover').classList.add('bought');
                    createFloatingText("è¿æ°”UP!", canvas.width/2, canvas.height/2 - 50, "#0f0");
                }
                updateInventoryUI(); // è´­ä¹°ååˆ·æ–°
            } else {
                createFloatingText("é’±ä¸å¤Ÿå–µ!", canvas.width/2, canvas.height/2 - 50, "#f00");
            }
        }

        window.nextLevelStart = function() {
            level++;
            initLevelData();
            hideAllScreens();
            document.getElementById('hud').style.display = 'flex';
            currentState = STATE.PLAYING;
            lastTime = performance.now();
        }

        function useBomb() {
            if (hook.status === 2 && hook.grabbedItem && inventory.bombs > 0) {
                inventory.bombs--;
                hook.grabbedItem = null; 
                hook.status = 2; 
                hook.pullSpeed = 20; 
                
                for(let i=0; i<20; i++) {
                    particles.push({
                        x: hook.x + Math.sin(hook.angle) * hook.length,
                        y: hook.y + Math.cos(hook.angle) * hook.length,
                        vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                        life: 0.5, color: '#ff4500', size: Math.random()*5+2
                    });
                }
                createFloatingText("BOOM!", hook.x + Math.sin(hook.angle) * hook.length, hook.y + Math.cos(hook.angle) * hook.length, "#f00");
                updateHUD();
                updateInventoryUI(); // ä½¿ç”¨ååˆ·æ–°
            }
        }

        function updateHUD() {
            document.getElementById('target-score').innerText = targetScore;
            document.getElementById('current-score').innerText = score;
            document.getElementById('level-num').innerText = level;
        }

        function createFloatingText(text, x, y, color) {
            let el = document.createElement('div');
            el.className = 'floater';
            el.innerText = text;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.style.color = color;
            document.getElementById('game-container').appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = "#444"; ctx.fillRect(430, 30, 40, 30);
            ctx.beginPath(); ctx.arc(440, 60, 8, 0, Math.PI*2); ctx.fillStyle="#222"; ctx.fill();
            ctx.beginPath(); ctx.arc(460, 60, 8, 0, Math.PI*2); ctx.fillStyle="#222"; ctx.fill();
            ctx.save(); ctx.translate(450, 40); ctx.rotate(Date.now() / 500);
            ctx.strokeStyle = "#ddd"; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(-10, 0); ctx.lineTo(10, 0); ctx.moveTo(0, -10); ctx.lineTo(0, 10);
            ctx.stroke(); ctx.restore();

            let endX = hook.x + Math.sin(hook.angle) * hook.length;
            let endY = hook.y + Math.cos(hook.angle) * hook.length;
            ctx.beginPath(); ctx.moveTo(hook.x, hook.y); ctx.lineTo(endX, endY);
            ctx.strokeStyle = hook.ropeColor; ctx.lineWidth = 2; ctx.stroke();

            ctx.save(); ctx.translate(endX, endY); ctx.rotate(-hook.angle);
            ctx.fillStyle = "#aaa";
            if (hook.status === 0) {
                ctx.beginPath(); ctx.moveTo(-5, -5); ctx.lineTo(-10, 10); ctx.lineTo(-5, 5); ctx.fill();
                ctx.beginPath(); ctx.moveTo(5, -5); ctx.lineTo(10, 10); ctx.lineTo(5, 5); ctx.fill();
            } else {
                ctx.beginPath(); ctx.moveTo(-5, -5); ctx.lineTo(-2, 10); ctx.lineTo(0, 5); ctx.fill();
                ctx.beginPath(); ctx.moveTo(5, -5); ctx.lineTo(2, 10); ctx.lineTo(0, 5); ctx.fill();
            }
            if (hook.grabbedItem) drawItem(hook.grabbedItem, 0, 15);
            ctx.restore();

            for (let item of items) drawItem(item, item.x, item.y);
            for (let p of particles) {
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
            }
        }

        function drawBackgroundOnly() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "rgba(255,255,255,0.1)";
            ctx.font = "100px Arial";
            ctx.textAlign = "center";
            ctx.fillText("â›ï¸", 450, 300);
        }

        function drawItem(item, x, y) {
            ctx.save(); ctx.translate(x, y);
            if (hook.grabbedItem === item) ctx.rotate(Math.sin(Date.now()/100)*0.2);
            
            ctx.fillStyle = item.color;
            if (item.type.includes('GOLD') || item.type === 'BAG') {
                ctx.beginPath(); ctx.arc(0, 0, item.radius, 0, Math.PI*2); ctx.fill();
                if (item.type === 'BAG') { ctx.fillStyle="#fff"; ctx.font="16px Arial"; ctx.textAlign="center"; ctx.fillText("?", 0, 5); }
                else { ctx.fillStyle="rgba(255,255,255,0.4)"; ctx.beginPath(); ctx.arc(-item.radius*0.3, -item.radius*0.3, item.radius*0.2, 0, Math.PI*2); ctx.fill(); }
            } else if (item.type.includes('ROCK')) {
                ctx.beginPath(); ctx.arc(0, 0, item.radius, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = "#555"; ctx.beginPath(); ctx.moveTo(-5, -5); ctx.lineTo(5, 5); ctx.stroke();
            } else if (item.type === 'DIAMOND') {
                ctx.beginPath(); ctx.moveTo(0, -item.radius); ctx.lineTo(item.radius, 0); ctx.lineTo(0, item.radius); ctx.lineTo(-item.radius, 0); ctx.fill();
            }
            ctx.restore();
        }

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Escape') {
                if (currentState === STATE.PLAYING || currentState === STATE.PAUSED) togglePause();
            }

            if (currentState !== STATE.PLAYING) return;
            
            if (e.code === 'ArrowDown' || e.code === 'Space' || e.code === 'KeyS') {
                if (hook.status === 0) hook.status = 1;
            }
            if (e.code === 'ArrowUp' || e.code === 'KeyW') {
                useBomb();
            }
        });
    </script>
</body>
</html>
