<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>汐凪的双排键工作站</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* 防止双击选中文本，保证游戏体验 */
        body { user-select: none; -webkit-user-select: none; }
    </style>
</head>
<body class="bg-[#1a1a1a]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // === 1. 手写图标组件 (替代 lucide-react) ===
        const Music = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
        );
        const Volume2 = ({ size, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
        );
        const ArrowUp = ({ size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>
        );
        const ArrowDown = ({ size }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>
        );

        // === 2. 定义音符频率 ===
        const NOTE_FREQS = {
          // 低音区 (Bass) - A 行控制
          'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81, 'F3': 174.61, 'F#3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'B3': 246.94,
          
          // 中高音区 (Melody) - Q 行控制
          'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
          'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25, 'F5': 698.46, 'F#5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'B5': 987.77
        };

        // === 3. 键盘映射 ===
        const KEY_MAP = {
          // === 下层键盘 (A 行) ===
          'a': 'C3', 's': 'D3', 'd': 'E3', 'f': 'F3', 'g': 'G3', 'h': 'A3', 'j': 'B3',
          'k': 'C4_LOW', 'l': 'D4_LOW', ';': 'E4_LOW', '\'': 'F4_LOW',
          // A 行黑键
          'z': 'C#3', 'x': 'D#3', 'c': 'F#3', 'v': 'G#3', 'b': 'A#3', 

          // === 上层键盘 (Q 行) ===
          'q': 'C4', 'w': 'D4', 'e': 'E4', 'r': 'F4', 't': 'G4', 'y': 'A4', 'u': 'B4', 
          'i': 'C5', 'o': 'D5', 'p': 'E5', '[': 'F5', ']': 'G5', '\\': 'A5',
          // Q 行黑键
          '2': 'C#4', '3': 'D#4', '5': 'F#4', '6': 'G#4', '7': 'A#4', '9': 'C#5', '0': 'D#5', '=': 'F#5'
        };

        // === 4. 键位显示标签 ===
        const KEY_LABELS = {
          // Low Row
          'C3': 'A', 'D3': 'S', 'E3': 'D', 'F3': 'F', 'G3': 'G', 'A3': 'H', 'B3': 'J',
          'C4_LOW': 'K', 'D4_LOW': 'L', 'E4_LOW': ';', 'F4_LOW': '\'',
          'C#3': 'Z', 'D#3': 'X', 'F#3': 'C', 'G#3': 'V', 'A#3': 'B', 
          'C#4_LOW': 'N', 'D#4_LOW': 'M',
          // High Row
          'C4': 'Q', 'D4': 'W', 'E4': 'E', 'F4': 'R', 'G4': 'T', 'A4': 'Y', 'B4': 'U',
          'C5': 'I', 'D5': 'O', 'E5': 'P', 'F5': '[', 'G5': ']', 'A5': '\\',
          'C#4': '2', 'D#4': '3', 'F#4': '5', 'G#4': '6', 'A#4': '7', 'C#5': '9', 'D#5': '0', 'F#5': '='
        };

        const RetroSynth = () => {
          const audioCtxRef = useRef(null);
          const [activeNotes, setActiveNotes] = useState({});
          const [settings, setSettings] = useState({
            waveform: 'triangle', 
            attack: 0.05, decay: 0.2, sustain: 0.4, release: 0.3
          });
          const [volume, setVolume] = useState(0.3);

          useEffect(() => {
            const initAudio = () => {
              if (!audioCtxRef.current) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtxRef.current = new AudioContext();
              }
              if (audioCtxRef.current.state === 'suspended') {
                audioCtxRef.current.resume();
              }
            };
            window.addEventListener('click', initAudio, { once: true });
            window.addEventListener('keydown', initAudio, { once: true });
          }, []);

          const playNote = (note, source = 'keyboard') => {
            const noteId = `${note}_${source}`; 
            if (!audioCtxRef.current || activeNotes[noteId]) return;

            const ctx = audioCtxRef.current;
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            osc.type = settings.waveform;
            const freqKey = note.replace('_LOW', '');
            osc.frequency.setValueAtTime(NOTE_FREQS[freqKey], ctx.currentTime);
            
            const now = ctx.currentTime;
            const { attack, decay, sustain } = settings;
            
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(volume, now + parseFloat(attack));
            gainNode.gain.exponentialRampToValueAtTime(volume * parseFloat(sustain) + 0.001, now + parseFloat(attack) + parseFloat(decay));

            osc.connect(gainNode);
            gainNode.connect(ctx.destination);
            osc.start();

            setActiveNotes(prev => ({ ...prev, [noteId]: { osc, gainNode } }));
          };

          const stopNote = (note, source = 'keyboard') => {
            const noteId = `${note}_${source}`;
            if (!activeNotes[noteId]) return;
            
            const { osc, gainNode } = activeNotes[noteId];
            const ctx = audioCtxRef.current;
            const now = ctx.currentTime;
            const { release } = settings;

            gainNode.gain.cancelScheduledValues(now);
            gainNode.gain.setValueAtTime(gainNode.gain.value, now);
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + parseFloat(release));
            
            osc.stop(now + parseFloat(release) + 0.1);
            
            setTimeout(() => {
              setActiveNotes(prev => {
                const newState = { ...prev };
                delete newState[noteId];
                return newState;
              });
            }, (parseFloat(release) + 0.1) * 1000);
          };

          useEffect(() => {
            const handleKeyDown = (e) => {
              if (e.isComposing || e.keyCode === 229) return;
              const key = e.key.toLowerCase();
              let note = KEY_MAP[key];
              
              if (note && !e.repeat) {
                const isHighRowKey = 'qwertyuiop[]\\23567890-='.includes(key);
                const source = isHighRowKey ? 'HIGH' : 'LOW';
                playNote(note, source);
              }
            };
            const handleKeyUp = (e) => {
              const key = e.key.toLowerCase();
              let note = KEY_MAP[key];
              if (note) {
                const isHighRowKey = 'qwertyuiop[]\\23567890-='.includes(key);
                const source = isHighRowKey ? 'HIGH' : 'LOW';
                stopNote(note, source);
              }
            };

            window.addEventListener('keydown', handleKeyDown);
            window.addEventListener('keyup', handleKeyUp);
            return () => {
              window.removeEventListener('keydown', handleKeyDown);
              window.removeEventListener('keyup', handleKeyUp);
            };
          }, [settings, volume, activeNotes]);

          // --- 键盘数据 ---
          const highKeys = [
              { note: 'C4', type: 'white' }, { note: 'C#4', type: 'black' }, { note: 'D4', type: 'white' }, { note: 'D#4', type: 'black' },
              { note: 'E4', type: 'white' }, { note: 'F4', type: 'white' }, { note: 'F#4', type: 'black' }, { note: 'G4', type: 'white' },
              { note: 'G#4', type: 'black' }, { note: 'A4', type: 'white' }, { note: 'A#4', type: 'black' }, { note: 'B4', type: 'white' },
              { note: 'C5', type: 'white' }, { note: 'C#5', type: 'black' }, { note: 'D5', type: 'white' }, { note: 'D#5', type: 'black' },
              { note: 'E5', type: 'white' }, { note: 'F5', type: 'white' }, { note: 'F#5', type: 'black' }, { note: 'G5', type: 'white' },
              { note: 'A5', type: 'white' },
          ];

          const lowKeys = [
              { note: 'C3', type: 'white' }, { note: 'C#3', type: 'black' }, { note: 'D3', type: 'white' }, { note: 'D#3', type: 'black' },
              { note: 'E3', type: 'white' }, { note: 'F3', type: 'white' }, { note: 'F#3', type: 'black' }, { note: 'G3', type: 'white' },
              { note: 'G#3', type: 'black' }, { note: 'A3', type: 'white' }, { note: 'A#3', type: 'black' }, { note: 'B3', type: 'white' },
              { note: 'C4_LOW', type: 'white' }, { note: 'C#4_LOW', type: 'black' }, { note: 'D4_LOW', type: 'white' }, { note: 'D#4_LOW', type: 'black' },
              { note: 'E4_LOW', type: 'white' }, { note: 'F4_LOW', type: 'white' },
          ];

          const KeyboardRow = ({ keys, sourceLabel, sourceId, colorClass }) => {
            const whiteKeys = keys.filter(k => k.type === 'white');
            const blackKeys = keys.filter(k => k.type === 'black');
            const WHITE_KEY_WIDTH_TOTAL = 58; 
            const BLACK_KEY_WIDTH = 30;

            return (
                <div className="relative mb-8 select-none w-full">
                    <div className="absolute -top-6 left-0 text-xs font-bold text-gray-400 flex items-center gap-2">
                        {sourceId === 'HIGH' ? <ArrowUp size={14} /> : <ArrowDown size={14} />}
                        {sourceLabel}
                    </div>

                    <div className="relative flex h-40 bg-[#0a0a0a] rounded border-t-4 border-gray-700 shadow-lg justify-center">
                        {/* 白键 */}
                        <div className="flex z-0 relative">
                            {whiteKeys.map((key) => {
                                const noteId = `${key.note}_${sourceId}`;
                                const isActive = !!activeNotes[noteId];
                                const displayNote = key.note.replace('_LOW', '');
                                
                                return (
                                    <div 
                                        key={noteId} 
                                        onMouseDown={() => playNote(key.note, sourceId)}
                                        onMouseUp={() => stopNote(key.note, sourceId)}
                                        onMouseLeave={() => stopNote(key.note, sourceId)}
                                        className={`
                                            relative w-14 h-full bg-white border-l border-b border-r border-gray-300 rounded-b-[4px] cursor-pointer
                                            active:scale-[0.98] origin-top transition-all duration-75 box-border mx-[1px] flex-shrink-0
                                            ${isActive ? `bg-${colorClass}-100 !h-[155px] shadow-inner border-${colorClass}-300` : 'hover:bg-gray-50'}
                                        `}
                                    >
                                        <div className="absolute bottom-3 w-full text-center">
                                            <span className={`block text-lg font-bold text-${colorClass}-600`}>{KEY_LABELS[key.note] || ''}</span>
                                            <span className="block text-[9px] text-gray-400">{displayNote}</span>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {/* 黑键 */}
                        <div className="absolute top-0 left-0 w-full flex justify-center pointer-events-none">
                             <div className="flex relative">
                                {whiteKeys.map((wKey) => (
                                    <div key={wKey.note} className="w-14 mx-[1px] h-0 flex-shrink-0"></div>
                                ))}
                                
                                {blackKeys.map((key) => {
                                    const noteId = `${key.note}_${sourceId}`;
                                    const isActive = !!activeNotes[noteId];
                                    const baseWhiteNote = key.note.replace('#', '');
                                    const whiteIndex = whiteKeys.findIndex(k => k.note === baseWhiteNote);
                                    if (whiteIndex === -1) return null;
                                    
                                    let leftPosition = (whiteIndex + 1) * WHITE_KEY_WIDTH_TOTAL - (BLACK_KEY_WIDTH / 2);
                                    const noteName = key.note.replace('_LOW', '');
                                    if (noteName.startsWith('C#') || noteName.startsWith('F#')) {
                                        leftPosition -= 4; 
                                    } else if (noteName.startsWith('D#') || noteName.startsWith('G#') || noteName.startsWith('A#')) {
                                        leftPosition += 4;
                                    }

                                    return (
                                        <div 
                                            key={noteId}
                                            onMouseDown={() => playNote(key.note, sourceId)}
                                            onMouseUp={() => stopNote(key.note, sourceId)}
                                            onMouseLeave={() => stopNote(key.note, sourceId)}
                                            className={`
                                                absolute top-0 w-[30px] h-24 bg-gray-900 rounded-b-[3px] cursor-pointer z-10 pointer-events-auto
                                                border-b-4 border-black shadow-[2px_2px_5px_rgba(0,0,0,0.5)] transition-all duration-75
                                                ${isActive ? `bg-gray-800 border-b-2 mt-[2px] !h-[94px] border-${colorClass}-500` : 'hover:bg-gray-800'}
                                            `}
                                            style={{ left: `${leftPosition}px` }}
                                        >
                                            <div className="absolute bottom-2 w-full text-center text-gray-500 text-[9px] font-bold">
                                                {KEY_LABELS[key.note] || ''}
                                            </div>
                                        </div>
                                    );
                                })}
                             </div>
                        </div>
                    </div>
                </div>
            );
          };

          return (
            <div className="flex flex-col items-center justify-center min-h-screen p-4 font-mono text-white select-none">
              <div className="w-full max-w-5xl p-8 rounded-xl border border-gray-800 shadow-[0_0_60px_rgba(0,0,0,0.8)] bg-[#121212]">
                
                <div className="flex items-center justify-between mb-6 border-b border-gray-800 pb-4">
                     <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-400 to-blue-400 flex items-center gap-3">
                        <Music className="text-pink-400" /> 
                        汐凪的双排键工作站
                     </h1>
                     <div className="flex gap-4 text-xs text-gray-500">
                        <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-400"></span> Q行: 高音</span>
                        <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-pink-400"></span> A行: 低音</span>
                     </div>
                </div>

                {/* 全局设置 */}
                <div className="flex gap-4 mb-8 bg-gray-900 p-4 rounded border border-gray-800">
                     <div className="flex items-center gap-2">
                        <Volume2 size={16} className="text-gray-400"/>
                        <input 
                            type="range" min="0" max="1" step="0.01" value={volume} 
                            onChange={e => setVolume(parseFloat(e.target.value))}
                            className="w-24 h-1 bg-gray-700 rounded accent-white"
                        />
                     </div>
                     <div className="h-6 w-px bg-gray-700 mx-2"></div>
                     <div className="flex gap-2">
                        {['sine', 'triangle', 'square', 'sawtooth'].map(t => (
                            <button 
                                key={t}
                                onClick={() => setSettings({...settings, waveform: t})}
                                className={`text-xs px-2 py-1 rounded border ${settings.waveform === t ? 'bg-gray-700 border-white text-white' : 'border-gray-700 text-gray-500 hover:border-gray-500'}`}
                            >
                                {t}
                            </button>
                        ))}
                     </div>
                </div>

                {/* 键盘区域：上下排列 */}
                <div className="flex flex-col items-center overflow-x-auto pb-4">
                    {/* 上层：高音区 (Q Row) */}
                    <KeyboardRow 
                        keys={highKeys} 
                        sourceLabel="高音区 Melody (按键: QWERTY...)" 
                        sourceId="HIGH" 
                        colorClass="blue"
                    />

                    {/* 下层：低音区 (A Row) */}
                    <KeyboardRow 
                        keys={lowKeys} 
                        sourceLabel="低音区 Bass (按键: ASDFGH...)" 
                        sourceId="LOW" 
                        colorClass="pink"
                    />
                </div>

                <div className="text-center text-gray-600 text-[10px] mt-4">
                    汐凪提示：尝试左手按下面 (Bass)，右手按上面 (Melody) 一起演奏吧喵！
                </div>

              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RetroSynth />);
    </script>
</body>
</html>
