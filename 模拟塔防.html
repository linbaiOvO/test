<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ±å‡ªçš„è¿·ä½ å¡”é˜² Polished V2 (â‰§â—¡â‰¦)</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #203040;
            color: white;
            user-select: none;
        }
        #game-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
        }
        canvas {
            background-color: #4caf50;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            cursor: default;
        }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 20px; box-sizing: border-box;
        }

        /* é¡¶éƒ¨ UI */
        .top-bar {
            display: flex; justify-content: space-between; width: 100%;
            pointer-events: auto;
        }
        #level-info {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px; border-radius: 15px; border: 2px solid #00ffff;
            backdrop-filter: blur(5px); display: flex; flex-direction: column;
        }
        .info-title { font-size: 12px; color: #aaa; }
        .info-val { font-size: 20px; color: #fff; font-weight: bold; }

        #status-bar {
            display: flex; gap: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 30px; border-radius: 50px; border: 2px solid #fff;
            align-items: center; backdrop-filter: blur(5px);
        }
        .stat { font-size: 20px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        #gold-val { color: #ffd700; }
        #lives-val { color: #ff4444; }

        #inventory { display: flex; gap: 10px; }
        .item-slot {
            background: rgba(0,0,0,0.7); border: 2px solid #888;
            width: 60px; height: 60px; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; position: relative;
        }
        .item-slot:hover { transform: scale(1.1); border-color: #fff; }
        .item-slot.active { border-color: #ffff00; box-shadow: 0 0 15px #ffff00; background: #444; }
        .item-slot:active { transform: scale(0.95); } 
        .item-icon { font-size: 24px; }
        .item-count { font-size: 12px; color: #fff; position: absolute; bottom: 2px; right: 5px; }
        .item-cost { font-size: 10px; color: #ffd700; position: absolute; top: -15px; background: #000; padding: 0 4px; border-radius: 4px;}

        /* åº•éƒ¨èœå• */
        #build-menu {
            align-self: center; display: flex; gap: 15px;
            background: rgba(0, 0, 0, 0.8); padding: 10px 20px;
            border-radius: 20px; pointer-events: auto; border: 2px solid #aaa;
        }
        .tower-btn {
            width: 70px; height: 70px;
            border-radius: 10px; border: 2px solid #555; background: #333;
            cursor: pointer; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: all 0.2s;
        }
        .tower-btn:hover { transform: translateY(-5px); border-color: #fff; }
        .tower-btn.selected { border-color: #00ff00; background: #444; box-shadow: 0 0 15px #00ff00; }
        .tower-icon { font-size: 24px; margin-bottom: 2px; }
        .tower-cost { font-size: 12px; color: #ffd700; font-weight: bold; }
        .tower-name { font-size: 10px; color: #ccc; }

        /* å…¨å±èœå• */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 20, 30, 0.95);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; z-index: 100; backdrop-filter: blur(10px);
        }
        h1 { font-size: 48px; color: #ffd700; text-shadow: 0 0 20px #ff8c00; margin-bottom: 10px; }
        h2 { color: #fff; margin-bottom: 20px; font-size: 32px; border-bottom: 2px solid #00ffff; padding-bottom: 10px;}
        
        button.big-btn {
            background: linear-gradient(to bottom, #4caf50, #2e7d32);
            border: none; padding: 15px 50px; color: white; font-size: 22px; font-weight: bold;
            border-radius: 50px; cursor: pointer; margin: 10px;
            box-shadow: 0 5px 0 #1b5e20; transition: transform 0.1s;
        }
        button.big-btn:active { transform: translateY(4px); box-shadow: 0 1px 0 #1b5e20; }
        button.secondary { background: #555; box-shadow: 0 5px 0 #333; }
        
        .level-grid { display: flex; gap: 20px; margin: 30px; }
        .level-card {
            background: #334; border: 2px solid #667; width: 140px; height: 160px;
            border-radius: 15px; cursor: pointer; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: all 0.2s;
            position: relative; overflow: hidden;
        }
        .level-card.lvl-1 { background: linear-gradient(135deg, #2e7d32, #1b5e20); }
        .level-card.lvl-2 { background: linear-gradient(135deg, #006064, #00363a); }
        .level-card.lvl-3 { background: linear-gradient(135deg, #b71c1c, #7f0000); }
        
        .level-card:hover { transform: scale(1.1); border-color: #00ffff; }
        .lvl-num { font-size: 36px; font-weight: bold; color: #fff; z-index: 1; }
        .lvl-desc { font-size: 12px; color: #ddd; margin-top: 5px; text-align: center; z-index: 1; }
        .lvl-deco { position: absolute; font-size: 80px; opacity: 0.2; top: 10px; }

        .info-table {
            background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;
            text-align: left; max-width: 600px; width: 80%; color: #ddd; margin-bottom: 20px;
            overflow-y: auto; max-height: 400px;
        }
        .info-row { display: flex; justify-content: space-between; margin: 5px 0; font-size: 14px; }
        .info-icon { width: 30px; display: inline-block; text-align: center; }

        #start-screen { display: flex; }
        
        #freeze-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 255, 255, 0.3);
            pointer-events: none; display: none; z-index: 50; mix-blend-mode: screen;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas" width="900" height="600"></canvas>
        <div id="freeze-overlay"></div>
    </div>

    <div id="ui-layer">
        <!-- Top UI -->
        <div class="top-bar" id="top-ui" style="display: none;">
            <div id="level-info">
                <span class="info-title">å½“å‰å…³å¡</span>
                <span class="info-val" id="lvl-name">LEVEL 1</span>
                <span class="info-title" style="margin-top: 5px;">æ³¢æ¬¡è¿›åº¦</span>
                <span class="info-val" style="color: #00ffff;"><span id="wave-curr">1</span> / <span id="wave-total">5</span></span>
            </div>
            <div id="status-bar">
                <div class="stat"><span class="stat-icon">â¤ï¸</span> <span id="lives-val">20</span></div>
                <div class="stat"><span class="stat-icon">ğŸ’°</span> <span id="gold-val">150</span></div>
            </div>
            <div id="inventory">
                <div class="item-slot" id="item-bomb" onclick="selectItem('bomb')">
                    <span class="item-cost">$50</span>
                    <span class="item-icon">ğŸ§¨</span>
                    <span class="item-count" id="count-bomb">0</span>
                </div>
                <div class="item-slot" id="item-ice" onclick="useGlobalIce()">
                    <span class="item-cost">$100</span>
                    <span class="item-icon">â„ï¸</span>
                    <span class="item-count" id="count-ice">0</span>
                </div>
            </div>
        </div>

        <!-- Build Menu -->
        <div id="build-menu" style="display: none;">
            <div class="tower-btn" onclick="selectTower('archer')" id="btn-archer">
                <span class="tower-icon">ğŸ¹</span>
                <span class="tower-name">å¼“ç®­å¡”</span>
                <span class="tower-cost">$50</span>
            </div>
            <div class="tower-btn" onclick="selectTower('cannon')" id="btn-cannon">
                <span class="tower-icon">ğŸ’£</span>
                <span class="tower-name">è½°ç‚¸å¡”</span>
                <span class="tower-cost">$120</span>
            </div>
            <div class="tower-btn" onclick="selectTower('ice')" id="btn-ice">
                <span class="tower-icon">ğŸ§Š</span>
                <span class="tower-name">å†°éœœå¡”</span>
                <span class="tower-cost">$80</span>
            </div>
            <div class="tower-btn" onclick="selectTower('sniper')" id="btn-sniper">
                <span class="tower-icon">ğŸ¯</span>
                <span class="tower-name">ç‹™å‡»å¡”</span>
                <span class="tower-cost">$200</span>
            </div>
        </div>

        <!-- Screens -->
        <div id="start-screen" class="screen">
            <h1>ğŸ° å²è±å§†é˜²å¾¡æˆ˜</h1>
            <p style="color: #aaa; margin-bottom: 30px;">ä¿å«èåœï¼Œå‡»é€€è½¯èŒå†›å›¢å–µï¼</p>
            <button class="big-btn" onclick="showLevelSelect()">å¼€å§‹æ¸¸æˆ</button>
        </div>

        <div id="level-select-screen" class="screen">
            <h2>é€‰æ‹©å…³å¡</h2>
            <div class="level-grid">
                <div class="level-card lvl-1" onclick="initGame(0)">
                    <span class="lvl-deco">ğŸŒ¿</span>
                    <span class="lvl-num">1</span>
                    <span class="lvl-desc">è‰åœ°å¹³åŸ</span>
                </div>
                <div class="level-card lvl-2" onclick="initGame(1)">
                    <span class="lvl-deco">ğŸŒ²</span>
                    <span class="lvl-num">2</span>
                    <span class="lvl-desc">å¹½æš—æ£®æ—</span>
                </div>
                <div class="level-card lvl-3" onclick="initGame(2)">
                    <span class="lvl-deco">ğŸŒ‹</span>
                    <span class="lvl-num">3</span>
                    <span class="lvl-desc">ç†”å²©è¿·å®«</span>
                </div>
            </div>
            <button class="big-btn secondary" onclick="goHome()">è¿”å›ä¸»é¡µ</button>
        </div>

        <div id="pause-screen" class="screen">
            <h2>â¸ï¸ æ¸¸æˆæš‚åœ</h2>
            <div class="info-table">
                <h3>ğŸ® æ“ä½œè¯´æ˜</h3>
                <div class="info-row"><span>å»ºé€ /é€‰ä¸­:</span> <span>é¼ æ ‡ç‚¹å‡»åœ°å›¾</span></div>
                <div class="info-row"><span>å‡ºå”®å¡”å°:</span> <span>é€‰ä¸­å¡”å°å -> ç‚¹å‡»çº¢è‰²å‡ºå”®æŒ‰é’®</span></div>
                <div class="info-row"><span>å°æç¤º:</span> <span>é¼ æ ‡ç§»åˆ°å·²æœ‰å¡”å°ä¼šæŠ–åŠ¨æç¤ºå“¦ï¼</span></div>
            </div>
            <div style="display: flex; gap: 20px;">
                <button class="big-btn" onclick="togglePause()">ç»§ç»­æ¸¸æˆ</button>
                <button class="big-btn secondary" onclick="goHome()">å›åˆ°ä¸»é¡µ</button>
            </div>
        </div>

        <div id="end-screen" class="screen">
            <h1 id="end-title"></h1>
            <p id="end-msg" style="font-size: 20px; color: #fff; margin-bottom: 30px;"></p>
            <button class="big-btn" onclick="showLevelSelect()">é€‰æ‹©å…³å¡</button>
            <button class="big-btn secondary" onclick="goHome()">å›åˆ°ä¸»é¡µ</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const TILE_SIZE = 50;
        const COLS = 18;
        const ROWS = 12;
        let frameCount = 0;

        const TOWERS = {
            archer: { name: 'å¼“ç®­å¡”', cost: 50, range: 150, damage: 25, rate: 40, color: '#8b4513', type: 'single' },
            cannon: { name: 'è½°ç‚¸å¡”', cost: 120, range: 180, damage: 60, rate: 100, color: '#333', type: 'aoe', blast: 80 },
            ice:    { name: 'å†°éœœå¡”', cost: 80, range: 120, damage: 5,  rate: 45, color: '#00ffff', type: 'slow' },
            sniper: { name: 'ç‹™å‡»å¡”', cost: 200, range: 400, damage: 150, rate: 150, color: '#556b2f', type: 'single' }
        };
        const ITEMS = {
            bomb: { cost: 50, name: 'ç‚¸å¼¹' },
            ice:  { cost: 100, name: 'æš´é£é›ª' }
        };

        const LEVELS = [
            { 
                name: "è‰åœ°å¹³åŸ", waves: 5, 
                path: [[0,2], [5,2], [5,8], [12,8], [12,4], [17,4]],
                theme: { bg: '#4caf50', path: '#d2b48c', deco: 'tree_round' }
            },
            { 
                name: "å¹½æš—æ£®æ—", waves: 8, 
                path: [[0,1], [3,1], [3,9], [8,9], [8,2], [14,2], [14,7], [17,7]],
                theme: { bg: '#1b5e20', path: '#5d4037', deco: 'tree_pine' }
            },
            { 
                name: "ç†”å²©è¿·å®«", waves: 12, 
                path: [[0,5], [2,5], [2,2], [6,2], [6,9], [10,9], [10,3], [15,3], [15,8], [17,8]],
                theme: { bg: '#3e2723', path: '#5d4037', deco: 'rock' }
            }
        ];

        let currentState = 'HOME';
        let currentLevelIdx = 0;
        let pathPoints = [];
        
        let gold = 0;
        let lives = 0;
        let wave = 0;
        let isWaveActive = false;
        let spawnTimer = 0;
        let enemiesToSpawn = 0;
        let waveDelayTimer = 0;
        let currentWaveConfig = {};

        let towers = [];
        let enemies = [];
        let bullets = [];
        let particles = [];
        let traps = [];
        let decorations = [];
        let inventory = { bomb: 0, ice: 0 };
        
        let globalFreezeTimer = 0;

        let selectedAction = null;
        let selectedTower = null; // æ–°å¢ï¼šå½“å‰é€‰ä¸­çš„å·²å»ºé€ å¡”
        
        let mouseX = 0, mouseY = 0;
        let hoverCol = -1, hoverRow = -1;
        let hoveredTower = null; // æ–°å¢ï¼šé¼ æ ‡æ‚¬åœçš„å¡”

        canvas.addEventListener('mousedown', onCanvasClick);
        canvas.addEventListener('mousemove', e => {
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
            hoverCol = Math.floor(mouseX / TILE_SIZE);
            hoverRow = Math.floor(mouseY / TILE_SIZE);
        });
        document.addEventListener('keydown', e => {
            if (e.code === 'Escape') togglePause();
        });

        requestAnimationFrame(gameLoop);

        // --- æµç¨‹æ§åˆ¶ ---
        function showLevelSelect() {
            document.querySelectorAll('.screen').forEach(el => el.style.display = 'none');
            document.getElementById('level-select-screen').style.display = 'flex';
        }

        function goHome() {
            currentState = 'HOME';
            document.querySelectorAll('.screen').forEach(el => el.style.display = 'none');
            document.getElementById('start-screen').style.display = 'flex';
            document.getElementById('top-ui').style.display = 'none';
            document.getElementById('build-menu').style.display = 'none';
        }

        function initGame(levelIdx) {
            currentLevelIdx = levelIdx;
            const levelData = LEVELS[levelIdx];
            
            gold = 300 + levelIdx * 100;
            lives = 20;
            wave = 0;
            inventory = { bomb: 1, ice: 1 };
            
            towers = [];
            enemies = [];
            bullets = [];
            particles = [];
            traps = [];
            decorations = [];
            globalFreezeTimer = 0;
            selectedTower = null;
            selectedAction = null;
            
            document.getElementById('freeze-overlay').style.display = 'none';
            
            // ç”Ÿæˆè·¯å¾„
            pathPoints = [];
            let pathSet = new Set();
            if(levelData.path && levelData.path.length > 0) {
                let curr = levelData.path[0];
                pathPoints.push({ x: curr[0]*TILE_SIZE + TILE_SIZE/2, y: curr[1]*TILE_SIZE + TILE_SIZE/2 });
                pathSet.add(`${curr[0]},${curr[1]}`);

                for(let i=1; i<levelData.path.length; i++) {
                    let next = levelData.path[i];
                    let dx = Math.sign(next[0] - curr[0]);
                    let dy = Math.sign(next[1] - curr[1]);
                    let tx = curr[0], ty = curr[1];
                    while(tx !== next[0] || ty !== next[1]) {
                        tx += dx; ty += dy;
                        pathSet.add(`${tx},${ty}`);
                    }
                    pathPoints.push({ x: next[0]*TILE_SIZE + TILE_SIZE/2, y: next[1]*TILE_SIZE + TILE_SIZE/2 });
                    curr = next;
                }
            }

            // è£…é¥°ç‰©
            for(let c=0; c<COLS; c++) {
                for(let r=0; r<ROWS; r++) {
                    if(!pathSet.has(`${c},${r}`) && Math.random() < 0.15) {
                        decorations.push({
                            x: c * TILE_SIZE + TILE_SIZE/2,
                            y: r * TILE_SIZE + TILE_SIZE/2,
                            type: levelData.theme.deco,
                            scale: 0.5 + Math.random() * 0.5
                        });
                    }
                }
            }

            document.querySelectorAll('.screen').forEach(el => el.style.display = 'none');
            document.getElementById('top-ui').style.display = 'flex';
            document.getElementById('build-menu').style.display = 'flex';
            
            document.getElementById('lvl-name').innerText = levelData.name;
            document.getElementById('wave-total').innerText = levelData.waves;
            
            // é‡ç½® UI é€‰ä¸­
            document.querySelectorAll('.tower-btn, .item-slot').forEach(el => el.classList.remove('selected', 'active'));

            updateUI();
            startNextWave();
            currentState = 'PLAYING';
        }

        function togglePause() {
            if (currentState === 'PLAYING') {
                currentState = 'PAUSED';
                document.getElementById('pause-screen').style.display = 'flex';
            } else if (currentState === 'PAUSED') {
                currentState = 'PLAYING';
                document.getElementById('pause-screen').style.display = 'none';
            }
        }

        function startNextWave() {
            if (wave >= LEVELS[currentLevelIdx].waves) {
                endGame(true);
                return;
            }
            wave++;
            isWaveActive = true;
            
            let count = 5 + wave * 2 + currentLevelIdx * 3;
            let hp = 30 + wave * 15 + currentLevelIdx * 20;
            let speed = 1.5 + (wave * 0.1);
            
            currentWaveConfig = { count, hp, speed, interval: 60 };
            enemiesToSpawn = count;
            spawnTimer = 0;
            updateUI();
        }

        function endGame(win) {
            currentState = 'END';
            document.getElementById('end-screen').style.display = 'flex';
            const title = document.getElementById('end-title');
            const msg = document.getElementById('end-msg');
            
            if (win) {
                title.innerText = "ğŸ‰ å®Œç¾å¤§èƒœåˆ©!";
                title.style.color = "#00ffff";
                msg.innerText = "èåœå®‰å…¨äº†å–µï¼";
            } else {
                title.innerText = "ğŸ’” èåœè¢«åƒæ‰äº†...";
                title.style.color = "#ff4444";
                msg.innerText = "å†è¯•ä¸€æ¬¡å§ï¼";
            }
        }

        function useGlobalIce() {
            if (currentState !== 'PLAYING') return;
            let cost = ITEMS.ice.cost;
            if (inventory.ice > 0 || gold >= cost) {
                if (inventory.ice > 0) inventory.ice--;
                else gold -= cost;
                
                globalFreezeTimer = 180;
                enemies.forEach(e => { e.postFreezeSlow = 180; });
                updateUI();
                document.getElementById('freeze-overlay').style.display = 'block';
                setTimeout(() => { document.getElementById('freeze-overlay').style.display = 'none'; }, 3000);
            } else {
                alert("é‡‘å¸ä¸è¶³å–µï¼éœ€è¦ $100");
            }
        }

        function gameLoop() {
            if (currentState === 'PLAYING') update();
            if (currentState !== 'HOME') draw();
            else {
                ctx.fillStyle = '#203040';
                ctx.fillRect(0,0,canvas.width, canvas.height);
            }
            requestAnimationFrame(gameLoop);
            frameCount++;
        }

        function update() {
            // æŸ¥æ‰¾é¼ æ ‡æ‚¬åœçš„å¡”
            hoveredTower = null;
            if (hoverCol >= 0 && hoverRow >= 0) {
                 // æ£€æŸ¥è¿™ä¸ªç½‘æ ¼é‡Œæœ‰æ²¡æœ‰å¡”
                 // towers å­˜çš„æ˜¯åƒç´ åæ ‡
                 const centerX = hoverCol * TILE_SIZE + TILE_SIZE/2;
                 const centerY = hoverRow * TILE_SIZE + TILE_SIZE/2;
                 hoveredTower = towers.find(t => Math.abs(t.x - centerX) < 5 && Math.abs(t.y - centerY) < 5);
            }

            if (globalFreezeTimer > 0) globalFreezeTimer--;

            if (enemiesToSpawn > 0) {
                spawnTimer++;
                if (spawnTimer > currentWaveConfig.interval) {
                    spawnEnemy();
                    spawnTimer = 0;
                    enemiesToSpawn--;
                }
            } else if (enemies.length === 0) {
                if (isWaveActive) {
                    isWaveActive = false;
                    waveDelayTimer = 180;
                } else {
                    waveDelayTimer--;
                    if (waveDelayTimer <= 0) startNextWave();
                }
            }

            for (let i = enemies.length - 1; i >= 0; i--) {
                let e = enemies[i];
                for (let j = traps.length - 1; j >= 0; j--) {
                    let t = traps[j];
                    if (Math.hypot(e.x - t.x, e.y - t.y) < 20) {
                        if (t.type === 'bomb') {
                            createExplosion(t.x, t.y, 80, 100); 
                            traps.splice(j, 1);
                        }
                    }
                }

                let currentSpeed = e.speed;
                if (globalFreezeTimer > 0) currentSpeed = 0;
                else {
                    if (e.postFreezeSlow > 0) { e.postFreezeSlow--; currentSpeed *= 0.5; }
                    if (e.slowTimer > 0) { e.slowTimer--; currentSpeed *= 0.6; }
                }

                if (currentSpeed > 0 && e.pathIdx < pathPoints.length) {
                    let target = pathPoints[e.pathIdx];
                    let dx = target.x - e.x;
                    let dy = target.y - e.y;
                    let dist = Math.hypot(dx, dy);
                    
                    if (dist <= currentSpeed) {
                        e.pathIdx++;
                        if (e.pathIdx >= pathPoints.length) {
                            lives--;
                            enemies.splice(i, 1);
                            updateUI();
                            if (lives <= 0) endGame(false);
                            continue;
                        }
                    } else {
                        e.x += (dx / dist) * currentSpeed;
                        e.y += (dy / dist) * currentSpeed;
                    }
                }
            }

            towers.forEach(t => {
                if (t.cooldown > 0) t.cooldown--;
                else {
                    let target = enemies.find(e => Math.hypot(e.x - t.x, e.y - t.y) <= t.range);
                    if (target) {
                        shoot(t, target);
                        t.cooldown = t.rate;
                    }
                }
            });

            for (let i = bullets.length - 1; i >= 0; i--) {
                let b = bullets[i];
                if (b.target && enemies.includes(b.target)) {
                    let angle = Math.atan2(b.target.y - b.y, b.target.x - b.x);
                    b.x += Math.cos(angle) * 10;
                    b.y += Math.sin(angle) * 10;
                    if (Math.hypot(b.target.x - b.x, b.target.y - b.y) < 10) {
                        hitEnemy(b.target, b);
                        bullets.splice(i, 1);
                    }
                } else {
                    if (b.type === 'aoe') {
                        let dist = Math.hypot(b.destX - b.x, b.destY - b.y);
                         let angle = Math.atan2(b.destY - b.y, b.destX - b.x);
                        b.x += Math.cos(angle) * 10;
                        b.y += Math.sin(angle) * 10;
                        if (dist < 10) {
                            createExplosion(b.x, b.y, b.blast, b.damage);
                            bullets.splice(i, 1);
                        }
                    } else {
                        bullets.splice(i, 1);
                    }
                }
            }

            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                if (p.life <= 0) particles.splice(i, 1);
            }
        }

        function spawnEnemy() {
            if(pathPoints.length === 0) return; 
            enemies.push({
                x: pathPoints[0].x,
                y: pathPoints[0].y,
                pathIdx: 1,
                hp: currentWaveConfig.hp,
                maxHp: currentWaveConfig.hp,
                speed: currentWaveConfig.speed,
                slowTimer: 0,
                postFreezeSlow: 0,
                color: `hsl(${Math.random()*60 + 80}, 100%, 50%)`
            });
        }

        function shoot(tower, target) {
            if (tower.type === 'aoe') {
                bullets.push({
                    x: tower.x, y: tower.y,
                    type: 'aoe', damage: tower.damage, blast: tower.blast,
                    destX: target.x, destY: target.y, color: '#000'
                });
            } else {
                bullets.push({
                    x: tower.x, y: tower.y,
                    type: tower.type, damage: tower.damage,
                    target: target, color: '#fff'
                });
            }
        }

        function hitEnemy(enemy, bullet) {
            enemy.hp -= bullet.damage;
            if (bullet.type === 'slow') {
                enemy.slowTimer = 120;
            }
            createParticles(enemy.x, enemy.y, bullet.color, 3);
            checkDeath(enemy);
        }

        function createExplosion(x, y, radius, damage) {
            createParticles(x, y, '#ffaa00', 20);
            enemies.forEach(e => {
                if (Math.hypot(e.x - x, e.y - y) < radius) {
                    e.hp -= damage;
                    checkDeath(e);
                }
            });
        }

        function checkDeath(enemy) {
            if (enemy.hp <= 0) {
                let idx = enemies.indexOf(enemy);
                if (idx > -1) {
                    enemies.splice(idx, 1);
                    gold += 15;
                    updateUI();
                }
            }
        }

        function selectTower(type) {
            if (selectedAction === type) {
                selectedAction = null;
                document.getElementById('btn-'+type).classList.remove('selected');
            } else {
                document.querySelectorAll('.tower-btn, .item-slot').forEach(el => el.classList.remove('selected', 'active'));
                selectedAction = type;
                selectedTower = null; // å–æ¶ˆé€‰ä¸­çš„å¡”
                document.getElementById('btn-'+type).classList.add('selected');
            }
        }

        function selectItem(type) {
            if (selectedAction === type) {
                selectedAction = null;
                document.getElementById('item-'+type).classList.remove('active');
            } else {
                document.querySelectorAll('.tower-btn, .item-slot').forEach(el => el.classList.remove('selected', 'active'));
                selectedAction = type;
                selectedTower = null; // å–æ¶ˆé€‰ä¸­çš„å¡”
                document.getElementById('item-'+type).classList.add('active');
            }
        }

        function isPointOnPath(x, y) {
            for (let i=0; i<pathPoints.length-1; i++) {
                let p1 = pathPoints[i];
                let p2 = pathPoints[i+1];
                if (pointToSegmentDist(x, y, p1.x, p1.y, p2.x, p2.y) < 25) return true;
            }
            return false;
        }

        function onCanvasClick(e) {
            if (currentState !== 'PLAYING') return;
            
            // 1. å¦‚æœæœ‰é€‰ä¸­çš„å¡”ï¼Œæ£€æµ‹æ˜¯å¦ç‚¹å‡»äº†å–å‡ºæŒ‰é’®
            if (selectedTower) {
                // æŒ‰é’®ä½ç½®ï¼šå¡”ä¸Šæ–¹40åƒç´ ï¼ŒåŠå¾„15
                let btnX = selectedTower.x;
                let btnY = selectedTower.y - 40;
                if (Math.hypot(mouseX - btnX, mouseY - btnY) < 20) {
                    // æ‰§è¡Œå–å‡º
                    sellTower(selectedTower);
                    selectedTower = null;
                    return;
                }
            }

            // 2. æ£€æµ‹æ˜¯å¦ç‚¹å‡»äº†å·²æœ‰çš„å¡” (åˆ‡æ¢é€‰ä¸­)
            if (hoveredTower) {
                if (selectedTower === hoveredTower) {
                    selectedTower = null; // å–æ¶ˆé€‰ä¸­
                } else {
                    selectedTower = hoveredTower;
                    // å¦‚æœæ­£åœ¨å»ºé€ ï¼Œå–æ¶ˆå»ºé€ çŠ¶æ€
                    if (selectedAction) {
                        document.querySelectorAll('.tower-btn, .item-slot').forEach(el => el.classList.remove('selected', 'active'));
                        selectedAction = null;
                    }
                }
                return;
            }
            
            // å¦‚æœç‚¹ç©ºåœ°ï¼Œå–æ¶ˆé€‰ä¸­å¡”
            selectedTower = null;

            // 3. å»ºé€ /é“å…·é€»è¾‘
            if (!selectedAction) return;

            const centerX = hoverCol * TILE_SIZE + TILE_SIZE/2;
            const centerY = hoverRow * TILE_SIZE + TILE_SIZE/2;
            let onPath = isPointOnPath(centerX, centerY);

            if (TOWERS[selectedAction]) {
                if (onPath) return;
                for(let t of towers) { if (Math.abs(t.x - centerX) < 5 && Math.abs(t.y - centerY) < 5) return; }

                let cost = TOWERS[selectedAction].cost;
                if (gold >= cost) {
                    gold -= cost;
                    towers.push({ x: centerX, y: centerY, ...TOWERS[selectedAction], cooldown: 0 });
                    updateUI();
                    createParticles(centerX, centerY, '#fff', 10);
                    
                    // å•æ¬¡å»ºé€ æ¨¡å¼ï¼šé‡ç½®é€‰æ‹©
                    selectTower(selectedAction);
                }
            } else if (selectedAction === 'bomb') { 
                if (!onPath) return;
                let cost = ITEMS.bomb.cost;
                if (inventory.bomb > 0 || gold >= cost) {
                    if (inventory.bomb > 0) inventory.bomb--;
                    else gold -= cost;
                    traps.push({ x: centerX, y: centerY, type: 'bomb' });
                    updateUI();
                    createParticles(centerX, centerY, '#f00', 5);
                    selectItem(selectedAction);
                }
            }
        }
        
        function sellTower(tower) {
            let idx = towers.indexOf(tower);
            if (idx > -1) {
                towers.splice(idx, 1);
                let refund = Math.floor(tower.cost * 0.5);
                gold += refund;
                updateUI();
                createParticles(tower.x, tower.y, '#ffd700', 10);
            }
        }

        function draw() {
            const theme = LEVELS[currentLevelIdx].theme;

            // èƒŒæ™¯
            ctx.fillStyle = theme.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (pathPoints.length < 2) return; 

            // è£…é¥°
            for (let d of decorations) {
                drawDecoration(d);
            }

            // è·¯å¾„
            ctx.lineWidth = 40;
            ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            ctx.strokeStyle = theme.path; 
            ctx.beginPath();
            ctx.moveTo(pathPoints[0].x, pathPoints[0].y);
            for (let i=1; i<pathPoints.length; i++) ctx.lineTo(pathPoints[i].x, pathPoints[i].y);
            ctx.stroke();
            
            // ç½‘æ ¼é«˜äº® (ä»…åœ¨å»ºé€ æ¨¡å¼æ˜¾ç¤º)
            if (selectedAction && hoverCol >= 0 && hoverCol < COLS && hoverRow >= 0 && hoverRow < ROWS) {
                ctx.save();
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)'; ctx.lineWidth = 2; ctx.setLineDash([5, 5]);
                ctx.strokeRect(hoverCol * TILE_SIZE, hoverRow * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                if (TOWERS[selectedAction]) {
                     ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                     ctx.fillRect(hoverCol * TILE_SIZE + 5, hoverRow * TILE_SIZE + 5, TILE_SIZE - 10, TILE_SIZE - 10);
                     ctx.beginPath();
                     ctx.arc(hoverCol * TILE_SIZE + TILE_SIZE/2, hoverRow * TILE_SIZE + TILE_SIZE/2, TOWERS[selectedAction].range, 0, Math.PI*2);
                     ctx.fillStyle = 'rgba(255, 255, 255, 0.1)'; ctx.fill();
                }
                ctx.restore();
            }

            // ç»ˆç‚¹
            let end = pathPoints[pathPoints.length-1];
            ctx.fillStyle = '#ff4444'; ctx.beginPath(); ctx.arc(end.x, end.y, 25, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#fff'; ctx.font="40px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText("ğŸ¥•", end.x, end.y);

            // å®ä½“ç»˜åˆ¶
            for (let t of traps) {
                ctx.font = "24px Arial"; ctx.textBaseline="bottom";
                ctx.fillText(t.type==='bomb'?'ğŸ§¨':'â„ï¸', t.x, t.y+8);
            }
            
            for (let t of towers) {
                // æ‚¬åœæŠ–åŠ¨æ•ˆæœ
                let shakeX = 0, shakeY = 0;
                if (t === hoveredTower && !selectedTower) {
                    let shakeAmt = 2;
                    shakeX = Math.sin(frameCount * 0.5) * shakeAmt;
                    shakeY = Math.cos(frameCount * 0.5) * shakeAmt;
                }

                // èŒƒå›´åœˆ (é€‰ä¸­æ—¶)
                if (t === selectedTower) {
                    ctx.beginPath();
                    ctx.arc(t.x, t.y, t.range, 0, Math.PI*2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.2)'; ctx.fill();
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)'; ctx.lineWidth=1; ctx.stroke();
                }

                ctx.save();
                ctx.translate(t.x + shakeX, t.y + shakeY);
                
                ctx.fillStyle = '#444'; ctx.fillRect(-18, -18, 36, 36);
                ctx.fillStyle = t.color; ctx.beginPath(); ctx.arc(0, 0, 14, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(0, 0, 6, 0, Math.PI*2); ctx.fill();
                
                // é€‰ä¸­æ—¶çš„å‡ºå”®æŒ‰é’®
                if (t === selectedTower) {
                    ctx.beginPath();
                    ctx.arc(0, -40, 15, 0, Math.PI*2);
                    ctx.fillStyle = '#ff4444'; ctx.fill();
                    ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
                    
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 14px Arial';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('$', 0, -40);
                }
                
                ctx.restore();
            }

            for (let e of enemies) {
                ctx.fillStyle = e.color; ctx.beginPath(); ctx.arc(e.x, e.y, 12, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = 'red'; ctx.fillRect(e.x-10, e.y-20, 20, 4);
                ctx.fillStyle = '#0f0'; ctx.fillRect(e.x-10, e.y-20, 20*(e.hp/e.maxHp), 4);
                if (globalFreezeTimer > 0 || e.slowTimer > 0 || e.postFreezeSlow > 0) {
                    ctx.strokeStyle='#0ff'; ctx.lineWidth=2; ctx.stroke();
                }
            }
            for (let b of bullets) {
                ctx.fillStyle = b.color; ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill();
            }
            for (let p of particles) {
                ctx.fillStyle = p.color; ctx.globalAlpha = p.life;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
            }
            ctx.globalAlpha = 1;
        }

        function drawDecoration(d) {
            if (d.type === 'tree_round') {
                ctx.fillStyle = '#388e3c'; ctx.beginPath(); ctx.arc(d.x, d.y, 15 * d.scale, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#4caf50'; ctx.beginPath(); ctx.arc(d.x-3, d.y-3, 10 * d.scale, 0, Math.PI*2); ctx.fill();
            } else if (d.type === 'tree_pine') {
                ctx.fillStyle = '#004d40'; ctx.beginPath(); 
                ctx.moveTo(d.x, d.y - 20 * d.scale); ctx.lineTo(d.x + 10 * d.scale, d.y + 10 * d.scale);
                ctx.lineTo(d.x - 10 * d.scale, d.y + 10 * d.scale); ctx.fill();
            } else if (d.type === 'rock') {
                ctx.fillStyle = '#5d4037'; ctx.beginPath(); ctx.arc(d.x, d.y, 10 * d.scale, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#3e2723'; ctx.beginPath(); ctx.arc(d.x+2, d.y+2, 8 * d.scale, 0, Math.PI*2); ctx.fill();
            }
        }

        function updateUI() {
            document.getElementById('gold-val').innerText = Math.floor(gold);
            document.getElementById('lives-val').innerText = lives;
            document.getElementById('wave-curr').innerText = wave;
            document.getElementById('count-bomb').innerText = inventory.bomb;
            document.getElementById('count-ice').innerText = inventory.ice;
        }

        function createParticles(x, y, color, count) {
            for(let i=0; i<count; i++) {
                particles.push({
                    x, y, vx: (Math.random()-0.5)*5, vy: (Math.random()-0.5)*5,
                    life: 1.0, color, size: Math.random()*3+2
                });
            }
        }

        function pointToSegmentDist(x, y, x1, y1, x2, y2) {
            var A = x - x1; var B = y - y1; var C = x2 - x1; var D = y2 - y1;
            var dot = A * C + B * D; var len_sq = C * C + D * D;
            var param = -1; if (len_sq != 0) param = dot / len_sq;
            var xx, yy;
            if (param < 0) { xx = x1; yy = y1; } else if (param > 1) { xx = x2; yy = y2; } else { xx = x1 + param * C; yy = y1 + param * D; }
            var dx = x - xx; var dy = y - yy; return Math.sqrt(dx * dx + dy * dy);
        }

    </script>
</body>
</html>