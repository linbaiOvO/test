<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—¥è®°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #ec4899; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 pb-24">

    <header class="sticky top-0 z-30 bg-white/80 backdrop-blur-md border-b border-slate-200">
        <div class="max-w-2xl mx-auto px-4 h-16 flex items-center justify-between">
            <a href="index.html" class="text-slate-400 hover:text-pink-500 transition-colors"><i data-lucide="home" class="w-6 h-6"></i></a>
            <h1 class="font-bold text-lg text-slate-700">æ—ç™½çš„è®°å¿†ç¢ç‰‡</h1>
            <button id="logoutBtn" class="hidden text-xs text-slate-400 hover:text-red-500 flex items-center gap-1 transition-colors">
                <i data-lucide="log-out" class="w-4 h-4"></i> é€€å‡º
            </button>
            <div id="guestPlaceholder" class="w-6"></div>
        </div>
    </header>

    <main class="max-w-2xl mx-auto p-4 md:p-6">
        <div id="statusMsg" class="hidden mb-4 p-3 rounded-xl text-sm font-medium text-center animate-bounce"></div>
        <div id="postsContainer" class="space-y-4">
            <div class="text-center py-10"><div class="loader mx-auto mb-3"></div><p class="text-slate-400 text-sm">æ­£åœ¨åŠ è½½è®°å¿†...</p></div>
        </div>
    </main>

    <a href="write.html" id="addBtn" class="hidden fixed bottom-8 right-8 w-14 h-14 bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-full shadow-lg hover:scale-110 active:scale-95 transition-all z-40 items-center justify-center">
        <i data-lucide="plus" class="w-8 h-8"></i>
    </a>

    <!-- å¼¹çª— -->
    <div id="postModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50 flex items-end md:items-center justify-center p-0 md:p-4 transition-opacity">
        <div class="bg-white w-full md:max-w-xl h-[85vh] md:h-auto md:max-h-[80vh] rounded-t-3xl md:rounded-3xl shadow-2xl p-6 relative flex flex-col animate-slide-up">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                <div id="adminActions" class="hidden flex gap-3">
                    <button id="editBtn" class="text-blue-500 hover:bg-blue-50 px-3 py-1.5 rounded-lg text-sm font-bold flex gap-1"><i data-lucide="edit" class="w-4 h-4"></i> ç¼–è¾‘</button>
                    <button id="deleteBtn" class="text-red-400 hover:bg-red-50 px-3 py-1.5 rounded-lg text-sm font-bold flex gap-1"><i data-lucide="trash-2" class="w-4 h-4"></i> åˆ é™¤</button>
                </div>
                <div id="guestActions" class="text-sm text-slate-400">æ—¥è®°è¯¦æƒ…</div>
                <button id="closeModal" class="p-2 bg-slate-100 hover:bg-slate-200 rounded-full text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="modalContent" class="overflow-y-auto flex-1 pr-2"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // âš ï¸ æ³¨æ„ï¼šè¿™é‡Œå¤šå¼•å…¥äº†ä¸€ä¸ª 'where'ï¼Œè¿™æ˜¯ç”¨æ¥ç­›é€‰çš„å…³é”®ï¼
        import { getFirestore, collection, getDocs, query, where, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // âš ï¸ æ¬§å°¼é…±çš„é…ç½® (ä¿æŒä¸å˜)
        const firebaseConfig = {
            apiKey: "AIzaSyDdqCijPyu6KDVAQMIrNUV2qAPTkk0Ree0",
            authDomain: "linbai-blog.firebaseapp.com",
            projectId: "linbai-blog",
            storageBucket: "linbai-blog.firebasestorage.app",
            messagingSenderId: "69762708684",
            appId: "1:69762708684:web:fb906d0cff4074730abe69",
            measurementId: "G-6S4NBJPSMJ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const postsCollection = collection(db, 'posts');

        let isAdmin = false; 
        let currentPostId = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                isAdmin = true;
                document.getElementById('logoutBtn').classList.remove('hidden');
                document.getElementById('guestPlaceholder').classList.add('hidden');
                document.getElementById('addBtn').classList.remove('hidden'); 
                document.getElementById('addBtn').style.display = 'flex';
            } else {
                isAdmin = false;
            }
            loadPosts(); 
        });

        document.getElementById('logoutBtn').onclick = () => {
            signOut(auth).then(() => window.location.reload());
        };

        const postsContainer = document.getElementById('postsContainer');
        
        async function loadPosts() {
            try {
                let q;

                // ğŸš¨ è¿™é‡Œçš„é€»è¾‘å˜äº†ï¼
                if (isAdmin) {
                    // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œè¯·æ±‚æ‰€æœ‰æ—¥è®°
                    q = query(postsCollection);
                } else {
                    // å¦‚æœæ˜¯æ¸¸å®¢ï¼Œåªè¯·æ±‚ 'status' ç­‰äº 'public' çš„æ—¥è®°
                    // è¿™æ ·æ‰ç¬¦åˆä¿å®‰(Rules)çš„è¦æ±‚ï¼
                    q = query(postsCollection, where("status", "==", "public"));
                }

                const querySnapshot = await getDocs(q);
                const posts = [];
                querySnapshot.forEach((doc) => posts.push({ id: doc.id, ...doc.data() }));
                
                // æœ¬åœ°æ’åºï¼ˆä¸ºäº†é¿å…æ¬§å°¼é…±å»é…ç½®å¤æ‚çš„ç´¢å¼•ï¼Œæˆ‘ä»¬å…ˆè·å–å†æ’åºï¼‰
                posts.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                postsContainer.innerHTML = ''; 
                
                if (posts.length === 0) {
                    postsContainer.innerHTML = `<div class="text-center py-20 opacity-50"><p>æš‚æ—¶æ²¡æœ‰å…¬å¼€æ—¥è®°å“¦</p></div>`;
                    return;
                }

                posts.forEach(post => {
                    // æ˜¾ç¤ºé€»è¾‘
                    const dateObj = post.createdAt ? new Date(post.createdAt.seconds * 1000) : new Date();
                    
                    let statusBadge = '';
                    if (isAdmin) {
                        if (post.status === 'private') statusBadge = `<span class="bg-purple-100 text-purple-600 text-xs px-2 py-0.5 rounded ml-2">ğŸ”’ ç§å¯†</span>`;
                        else if (post.status === 'draft') statusBadge = `<span class="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded ml-2">ğŸ“ è‰ç¨¿</span>`;
                    }

                    const card = document.createElement('article');
                    card.className = `bg-white p-5 rounded-2xl shadow-sm border border-slate-100 active:scale-[0.98] transition-all cursor-pointer hover:shadow-md ${post.status === 'draft' ? 'opacity-70 grayscale' : ''}`;
                    card.innerHTML = `
                        <div class="flex items-baseline gap-3 mb-2">
                            <span class="text-2xl font-bold text-slate-800">${dateObj.getDate()}</span>
                            <div class="flex flex-col text-xs text-slate-400"><span>${dateObj.toLocaleDateString('zh-CN', { weekday: 'short' })}</span><span>${dateObj.getFullYear()}.${dateObj.getMonth()+1}</span></div>
                            <h3 class="flex-1 font-bold text-slate-700 ml-2 truncate flex items-center">
                                ${escapeHtml(post.title)} ${statusBadge}
                            </h3>
                        </div>
                        <p class="text-slate-500 text-sm line-clamp-2 leading-relaxed">${escapeHtml(post.content)}</p>`;
                    card.onclick = () => openModal(post);
                    postsContainer.appendChild(card);
                });

            } catch (error) { 
                console.error(error); 
                postsContainer.innerHTML = `<div class="text-center text-red-400 py-10">
                    <p>åŠ è½½å¤±è´¥äº† ( >ï¹<ã€‚)</p>
                    <p class="text-xs mt-2 text-slate-400">${error.message}</p>
                </div>`;
            }
        }

        // --- å‰©ä¸‹çš„å¼¹çª—é€»è¾‘ä¿æŒä¸å˜ ---
        const modal = document.getElementById('postModal');
        const modalContent = document.getElementById('modalContent');
        const adminActions = document.getElementById('adminActions');
        const guestActions = document.getElementById('guestActions');
        let currentPost = null;

        function openModal(post) {
            currentPostId = post.id;
            const dateObj = post.createdAt ? new Date(post.createdAt.seconds * 1000) : new Date();
            
            if (isAdmin) {
                adminActions.classList.remove('hidden');
                guestActions.classList.add('hidden');
            } else {
                adminActions.classList.add('hidden');
                guestActions.classList.remove('hidden');
            }

            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold text-slate-800 mb-2">${escapeHtml(post.title)}</h2>
                <div class="text-xs text-slate-400 mb-6 pb-4 border-b border-slate-50 flex gap-4">
                    <span>${dateObj.toLocaleString()}</span>
                    ${isAdmin && post.status ? `<span class="uppercase font-bold tracking-wider text-pink-400">${post.status}</span>` : ''}
                </div>
                <div class="text-slate-600 leading-relaxed whitespace-pre-wrap text-base">${escapeHtml(post.content)}</div>
            `;
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        document.getElementById('editBtn').onclick = () => {
            window.location.href = `write.html?id=${currentPostId}`;
        };

        document.getElementById('deleteBtn').onclick = async () => {
            if (confirm('çœŸçš„è¦åˆ é™¤å—ï¼Ÿ')) {
                await deleteDoc(doc(db, "posts", currentPostId));
                modal.classList.add('hidden');
                loadPosts();
            }
        };

        document.getElementById('closeModal').onclick = () => modal.classList.add('hidden');
        modal.onclick = (e) => { if (e.target === modal) modal.classList.add('hidden'); }
        function escapeHtml(t) { return t ? t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""; }
    </script>
    <style>.animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); } @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }</style>
</body>
</html>
