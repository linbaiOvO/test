<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¬§å°¼é…±çš„ç§å¯†æ—¥è®°æœ¬</title>
    <!-- ğŸ’„ å¼•å…¥ Tailwind CSS è®©ç•Œé¢å˜æ¼‚äº® -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ğŸ¨ å¼•å…¥å›¾æ ‡åº“ -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        /* æ—‹è½¬çš„åŠ è½½åœˆåœˆ */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #ec4899; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-red-50 min-h-screen text-slate-800">

    <div id="app" class="max-w-3xl mx-auto p-4 md:p-8">
        
        <!-- ğŸ  é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="flex justify-between items-center mb-8 bg-white/60 p-4 rounded-2xl backdrop-blur-md shadow-sm">
            <!-- è¿”å›é¦–é¡µçš„æŒ‰é’® -->
            <a href="index.html" class="flex items-center gap-1 text-slate-500 hover:text-pink-500 transition-colors font-bold text-sm">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                è¿”å›é¦–é¡µ
            </a>

            <div class="flex items-center gap-2">
                <span class="text-2xl">ğŸ““</span>
                <h1 class="text-xl font-bold text-slate-700">æˆ‘çš„äº‘ç«¯æ—¥è®°</h1>
            </div>

            <!-- å†™æ—¥è®°æŒ‰é’® -->
            <button id="toggleAdminBtn" class="bg-pink-100 text-pink-600 hover:bg-pink-200 px-4 py-2 rounded-full transition-colors flex items-center gap-2 font-bold text-sm shadow-sm">
                <i data-lucide="pen-tool" class="w-4 h-4"></i> è®°ä¸€ç¬”
            </button>
        </header>

        <!-- ğŸ”” çŠ¶æ€æç¤ºæ¡ (æ¯”å¦‚ï¼šå‘å¸ƒæˆåŠŸï¼) -->
        <div id="statusMsg" class="hidden mb-4 p-4 rounded-xl text-sm font-medium animate-bounce text-center"></div>

        <!-- âœï¸ å†™ä½œé¢æ¿ (é»˜è®¤éšè—) -->
        <div id="adminPanel" class="hidden glass rounded-3xl p-6 mb-8 shadow-xl border border-white/50 animate-fade-in-down relative overflow-hidden">
            <!-- è£…é¥°èƒŒæ™¯ -->
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-pink-200 rounded-full blur-3xl opacity-30 pointer-events-none"></div>
            
            <h2 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                <span class="bg-purple-100 text-purple-600 p-1.5 rounded-lg"><i data-lucide="sparkles" class="w-4 h-4"></i></span> 
                ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆå–µï¼Ÿ
            </h2>
            
            <input type="text" id="newTitle" placeholder="ç»™æ—¥è®°èµ·ä¸ªæ ‡é¢˜å§..." class="w-full mb-3 p-3 rounded-xl bg-white border border-slate-200 focus:outline-none focus:ring-2 focus:ring-pink-300 transition-all shadow-sm">
            
            <textarea id="newContent" rows="5" placeholder="åœ¨è¿™é‡Œå†™ä¸‹å¿ƒæƒ…..." class="w-full mb-4 p-3 rounded-xl bg-white border border-slate-200 focus:outline-none focus:ring-2 focus:ring-pink-300 transition-all shadow-sm resize-none"></textarea>
            
            <div class="flex justify-end gap-3">
                <button id="cancelBtn" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-xl transition-colors font-medium">æ”¶èµ·</button>
                <button id="publishBtn" class="px-6 py-2 bg-gradient-to-r from-pink-500 to-purple-500 text-white font-bold rounded-xl shadow-md hover:shadow-lg active:scale-95 transition-all flex items-center gap-2">
                    <i data-lucide="send" class="w-4 h-4"></i> å‘å¸ƒæ—¥è®°
                </button>
            </div>
        </div>

        <!-- ğŸ“š æ—¥è®°åˆ—è¡¨å±•ç¤ºåŒº -->
        <div id="postsContainer" class="space-y-6 pb-20">
            <!-- åŠ è½½åŠ¨ç”» -->
            <div class="text-center py-10">
                <div class="loader mx-auto mb-3"></div>
                <p class="text-slate-400 text-sm animate-pulse">æ­£åœ¨ä»äº‘ç«¯è·å–æ¬§å°¼é…±çš„è®°å¿†...</p>
            </div>
        </div>

    </div>

    <!-- ğŸ“– é˜…è¯»æ—¥è®°çš„å¼¹çª— (Modal) -->
    <div id="postModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white w-full max-w-2xl max-h-[85vh] overflow-y-auto rounded-3xl shadow-2xl p-6 md:p-10 relative animate-scale-up border border-white/20">
            <button id="closeModal" class="absolute top-4 right-4 p-2 bg-slate-100 hover:bg-slate-200 rounded-full text-slate-500 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- ğŸ”¥ æ ¸å¿ƒé­”æ³•ï¼šFirebase ä»£ç  -->
    <script type="module">
        // 1. å¼•å…¥ Firebase å·¥å…·åŒ…
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. âœ¨ æ¬§å°¼é…±çš„é…ç½® (æ±å‡ªå·²ç»å¸®ä½ å¡«å¥½å•¦ï¼Œä¸ç”¨æ”¹ï¼) âœ¨
        const firebaseConfig = {
            apiKey: "AIzaSyDdqCijPyu6KDVAQMIrNUV2qAPTkk0Ree0",
            authDomain: "linbai-blog.firebaseapp.com",
            projectId: "linbai-blog",
            storageBucket: "linbai-blog.firebasestorage.app",
            messagingSenderId: "69762708684",
            appId: "1:69762708684:web:fb906d0cff4074730abe69",
            measurementId: "G-6S4NBJPSMJ"
        };

        // 3. å¯åŠ¨ Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const postsCollection = collection(db, 'posts'); // æˆ‘ä»¬çš„æ—¥è®°éƒ½å­˜åœ¨ 'posts' è¿™ä¸ªæ ¼å­é‡Œ

        console.log("æ—¥è®°æœ¬è¿æ¥æˆåŠŸå–µï¼ğŸ”“");

        // --- ä¸‹é¢æ˜¯æ§åˆ¶é¡µé¢çš„é€»è¾‘ ---

        const toggleAdminBtn = document.getElementById('toggleAdminBtn');
        const adminPanel = document.getElementById('adminPanel');
        const cancelBtn = document.getElementById('cancelBtn');
        const publishBtn = document.getElementById('publishBtn');
        const postsContainer = document.getElementById('postsContainer');
        const newTitle = document.getElementById('newTitle');
        const newContent = document.getElementById('newContent');
        const statusMsg = document.getElementById('statusMsg');

        // åˆå§‹åŒ–å›¾æ ‡
        lucide.createIcons();

        // åˆ‡æ¢å†™ä½œé¢æ¿
        toggleAdminBtn.addEventListener('click', () => {
            adminPanel.classList.toggle('hidden');
            if (!adminPanel.classList.contains('hidden')) {
                newTitle.focus(); // æ‰“å¼€æ—¶è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
            }
        });

        cancelBtn.addEventListener('click', () => adminPanel.classList.add('hidden'));

        // å‘å¸ƒæ—¥è®°
        publishBtn.addEventListener('click', async () => {
            const title = newTitle.value.trim();
            const content = newContent.value.trim();

            if (!title || !content) {
                showStatus('ğŸ¥º æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©ºå“¦ï¼', 'error');
                return;
            }

            publishBtn.disabled = true;
            publishBtn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> å‘é€ä¸­...`;
            lucide.createIcons();

            try {
                // å†™å…¥äº‘ç«¯
                await addDoc(postsCollection, {
                    title: title,
                    content: content,
                    createdAt: serverTimestamp(),
                    author: "æ¬§å°¼é…±"
                });

                showStatus('ğŸ‰ æ—¥è®°ä¿å­˜æˆåŠŸå•¦ï¼', 'success');
                newTitle.value = '';
                newContent.value = '';
                adminPanel.classList.add('hidden');
                loadPosts(); // åˆ·æ–°åˆ—è¡¨
            } catch (error) {
                console.error("Error:", error);
                if (error.code === 'permission-denied') {
                    showStatus('ğŸ”’ æ— æ³•å†™å…¥ï¼è¯·æ£€æŸ¥ Firebase æ˜¯å¦å¼€å¯äº† Test Modeï¼', 'error');
                } else {
                    showStatus('ğŸ˜­ ä¿å­˜å¤±è´¥äº†ï¼š' + error.message, 'error');
                }
            } finally {
                publishBtn.disabled = false;
                publishBtn.innerHTML = `<i data-lucide="send" class="w-4 h-4"></i> å‘å¸ƒæ—¥è®°`;
                lucide.createIcons();
            }
        });

        // è¯»å–æ—¥è®°åˆ—è¡¨
        async function loadPosts() {
            postsContainer.innerHTML = '<div class="loader mx-auto my-10"></div>';
            
            try {
                const q = query(postsCollection); 
                const querySnapshot = await getDocs(q);
                
                postsContainer.innerHTML = ''; 

                const posts = [];
                querySnapshot.forEach((doc) => {
                    posts.push({ id: doc.id, ...doc.data() });
                });
                
                // æŒ‰æ—¶é—´æ’åºï¼šæœ€æ–°çš„åœ¨ä¸Šé¢
                posts.sort((a, b) => {
                    const timeA = a.createdAt ? a.createdAt.seconds : 0;
                    const timeB = b.createdAt ? b.createdAt.seconds : 0;
                    return timeB - timeA;
                });

                if (posts.length === 0) {
                    postsContainer.innerHTML = `
                        <div class="text-center py-16 bg-white/40 rounded-3xl border border-dashed border-slate-300">
                            <p class="text-4xl mb-4">ğŸƒ</p>
                            <p class="text-slate-500 font-medium">è¿™é‡Œè¿˜æ˜¯ä¸€ç‰‡ç©ºç™½å‘¢</p>
                            <p class="text-slate-400 text-sm mt-2">å¿«ç‚¹å‡»å³ä¸Šè§’å†™ä¸‹ç¬¬ä¸€ç¯‡æ—¥è®°å§ï¼</p>
                        </div>
                    `;
                    return;
                }

                posts.forEach(post => {
                    const dateObj = post.createdAt ? new Date(post.createdAt.seconds * 1000) : new Date();
                    const dateStr = dateObj.toLocaleDateString();
                    const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    const card = document.createElement('article');
                    card.className = 'bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md hover:-translate-y-1 transition-all cursor-pointer group';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-xl font-bold text-slate-800 group-hover:text-pink-500 transition-colors line-clamp-1">${escapeHtml(post.title)}</h3>
                            <div class="text-right">
                                <div class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-md">${dateStr}</div>
                            </div>
                        </div>
                        <p class="text-slate-500 line-clamp-3 text-sm leading-relaxed">${escapeHtml(post.content)}</p>
                        <div class="mt-4 flex items-center gap-1 text-xs text-pink-400 font-medium opacity-0 group-hover:opacity-100 transition-opacity">
                            é˜…è¯»å…¨æ–‡ <i data-lucide="arrow-right" class="w-3 h-3"></i>
                        </div>
                    `;
                    card.onclick = () => openModal(post);
                    postsContainer.appendChild(card);
                });
                lucide.createIcons(); // åˆ·æ–°å›¾æ ‡

            } catch (error) {
                console.error("Load Error:", error);
                let msg = 'è¯»å–å¤±è´¥æƒ¹ ğŸ˜¿';
                if (error.code === 'permission-denied') msg = 'ğŸ”’ æƒé™ä¸è¶³ï¼šè¯·åœ¨ Firebase åå°å¼€å¯ Test Modeï¼';
                postsContainer.innerHTML = `<div class="text-center text-red-500 p-4 bg-red-50 rounded-xl font-bold">${msg}</div>`;
            }
        }

        // å®‰å…¨è¿‡æ»¤
        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // æç¤ºæ¡†
        function showStatus(msg, type) {
            statusMsg.innerText = msg;
            statusMsg.className = `mb-4 p-4 rounded-xl text-sm font-medium animate-bounce text-center shadow-sm ${type === 'error' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`;
            statusMsg.classList.remove('hidden');
            setTimeout(() => statusMsg.classList.add('hidden'), 4000);
        }

        // å¼¹çª—é€»è¾‘
        const modal = document.getElementById('postModal');
        const modalContent = document.getElementById('modalContent');
        
        function openModal(post) {
            const dateObj = post.createdAt ? new Date(post.createdAt.seconds * 1000) : new Date();
            const fullDate = dateObj.toLocaleString();

            modalContent.innerHTML = `
                <h2 class="text-2xl md:text-3xl font-bold text-slate-800 mb-4 leading-tight">${escapeHtml(post.title)}</h2>
                <div class="flex items-center gap-4 text-xs text-slate-400 mb-8 border-b border-slate-100 pb-4">
                    <span class="flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> ${fullDate}</span>
                    <span class="flex items-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> æ¬§å°¼é…±</span>
                </div>
                <div class="text-slate-600 leading-relaxed whitespace-pre-wrap text-base md:text-lg">${escapeHtml(post.content)}</div>
            `;
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        document.getElementById('closeModal').onclick = () => modal.classList.add('hidden');
        modal.onclick = (e) => { if (e.target === modal) modal.classList.add('hidden'); }

        // ğŸš€ å¯åŠ¨é¡µé¢
        loadPosts();

    </script>
    <style>
        .animate-fade-in-down { animation: fadeInDown 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-scale-up { animation: scaleUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleUp { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</body>
</html>
